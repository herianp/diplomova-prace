---
phase: 06-performance
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/DashboardComponent.vue
  - src/components/dashboard/VotingChart.vue
  - src/components/dashboard/SurveyTypesChart.vue
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Dashboard chart cards render only when scrolled into viewport (lazy loading)"
    - "Team switching does not accumulate listeners (PRF-03 verified)"
    - "Notification pagination stops fetching when all data loaded (PRF-04 verified)"
    - "Skeleton placeholders shown for dashboard charts before viewport entry"
  artifacts:
    - path: "src/components/DashboardComponent.vue"
      provides: "Lazy-loaded chart section using useChartLazyLoad"
      contains: "useChartLazyLoad"
    - path: "src/components/dashboard/VotingChart.vue"
      provides: "Dashboard voting chart (HTML/CSS bars, not Chart.js)"
    - path: "src/components/dashboard/SurveyTypesChart.vue"
      provides: "Dashboard survey types chart (SVG pie, not Chart.js)"
  key_links:
    - from: "src/components/DashboardComponent.vue"
      to: "src/composables/useChartLazyLoad.ts"
      via: "import useChartLazyLoad"
      pattern: "useChartLazyLoad"
    - from: "src/components/new/TeamCard.vue"
      to: "src/services/listenerRegistry.ts"
      via: "unregisterByScope('team')"
      pattern: "unregisterByScope.*team"
    - from: "src/pages/NotificationsPage.vue"
      to: "hasMore guard"
      via: "if (!lastDoc || !hasMore.value) return"
      pattern: "hasMore\\.value"
---

<objective>
Add lazy loading to DashboardComponent chart section, and verify PRF-03 (listener cleanup) and PRF-04 (pagination boundary) are already correctly implemented.

Purpose: Dashboard renders VotingChart and SurveyTypesChart eagerly even when scrolled below the fold. Wrapping in intersection observer defers rendering. PRF-03 and PRF-04 were implemented in Phases 02 and original codebase respectively -- this plan verifies and documents their correctness.

Output: Dashboard with lazy chart section, verification documentation for PRF-03/PRF-04.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-performance/06-RESEARCH.md
@.planning/phases/06-performance/06-01-SUMMARY.md
@src/components/DashboardComponent.vue
@src/components/new/TeamCard.vue
@src/components/new/TeamDropdown.vue
@src/pages/NotificationsPage.vue
@src/services/listenerRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lazy loading to DashboardComponent chart section</name>
  <files>src/components/DashboardComponent.vue</files>
  <action>
1. Import `useChartLazyLoad` from `@/composables/useChartLazyLoad` (created in 06-01).

2. Create two lazy load instances for the two chart cards:
   ```
   const { chartContainer: votingContainer, isVisible: votingVisible } = useChartLazyLoad()
   const { chartContainer: typesContainer, isVisible: typesVisible } = useChartLazyLoad()
   ```

3. In the template, the "Charts Section" `<div class="row q-col-gutter-md">` contains two `<div class="col-12 col-md-6">` cards. Update each:

   For VotingChart card (first col-12 col-md-6):
   - Add `ref="votingContainer"` on the outer div
   - Wrap content conditionally:
     ```
     <template v-if="votingVisible">
       <VotingChart :surveys="filteredRecentSurveys" :user-uid="currentUser?.uid" />
     </template>
     <q-skeleton v-else type="rect" height="200px" />
     ```
   - Keep the q-card wrapper and header (icon + title) always visible -- only the chart content is lazy

   For SurveyTypesChart card (second col-12 col-md-6):
   - Add `ref="typesContainer"` on the outer div
   - Wrap content conditionally:
     ```
     <template v-if="typesVisible">
       <SurveyTypesChart :surveys="filteredSurveys" />
     </template>
     <q-skeleton v-else type="rect" height="200px" />
     ```

Note: These dashboard charts are lightweight (HTML bars and SVG pie, not Chart.js canvas). The lazy loading prevents DOM rendering of complex vote calculations until needed, providing minor performance benefit. The main benefit is consistency with the ReportsCharts pattern.
  </action>
  <verify>
Run `quasar build` to confirm no compilation errors.
Open app, navigate to Dashboard. If charts section is below the fold on smaller screens, verify skeleton appears until scroll. On larger screens where charts are in viewport, they render immediately (rootMargin: 50px handles near-viewport elements).
  </verify>
  <done>
DashboardComponent chart cards lazy-loaded with useChartLazyLoad composable. Skeleton placeholders shown until viewport entry. Card headers remain visible for layout stability.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify PRF-03 listener cleanup and PRF-04 pagination boundary</name>
  <files>src/components/new/TeamCard.vue, src/components/new/TeamDropdown.vue, src/pages/NotificationsPage.vue, src/services/listenerRegistry.ts</files>
  <action>
1. **PRF-03 Verification (Listener Cleanup on Team Switch):**
   - Read `src/components/new/TeamCard.vue` and confirm `listenerRegistry.unregisterByScope('team')` is called before setting new team
   - Read `src/components/new/TeamDropdown.vue` and confirm same pattern
   - Read `src/services/listenerRegistry.ts` and confirm `unregisterByScope('team')` unsubscribes all team-scoped listeners
   - Add a verification comment in TeamCard.vue near the unregisterByScope call:
     ```
     // PRF-03: Verified - team-scoped listeners cleaned up before switching teams
     // Prevents memory accumulation from accumulated listeners (Phase 06)
     ```
   - Add same comment in TeamDropdown.vue

2. **PRF-04 Verification (Notification Pagination Boundary):**
   - Read `src/pages/NotificationsPage.vue` and confirm:
     a. `hasMore` ref initialized to true (line ~229)
     b. Guard at top of loadMore: `if (!lastDoc || !hasMore.value) return` (line ~297)
     c. `hasMore.value = result.hasMore` updates after fetch (line ~310)
     d. Template uses `v-if="hasMore && !loading"` to hide Load More button (line ~188)
   - Read `src/services/notificationFirebase.ts` and confirm `hasMore: snapshot.docs.length === pageSize` (line ~80)
   - Add a verification comment in NotificationsPage.vue near the hasMore guard:
     ```
     // PRF-04: Verified - pagination stops when hasMore is false
     // Button hidden via v-if="hasMore", guard prevents redundant Firestore queries (Phase 06)
     ```

3. Both PRF-03 and PRF-04 are already correctly implemented. No code changes needed beyond verification comments.

Do NOT modify the logic of either feature. Only add short verification comments.
  </action>
  <verify>
Grep for "PRF-03" in TeamCard.vue and TeamDropdown.vue to confirm comments added.
Grep for "PRF-04" in NotificationsPage.vue to confirm comment added.
Run `quasar build` to confirm no errors introduced.
  </verify>
  <done>
PRF-03 verified: team-scoped listeners cleaned up via unregisterByScope('team') in both TeamCard and TeamDropdown before team switch. PRF-04 verified: hasMore guard prevents redundant queries, button hidden when data exhausted, hasMore correctly set from snapshot size comparison.
  </done>
</task>

</tasks>

<verification>
- `grep -r "useChartLazyLoad" src/components/DashboardComponent.vue` confirms lazy loading integration
- `grep -r "PRF-03" src/components/new/` confirms listener verification comments
- `grep -r "PRF-04" src/pages/NotificationsPage.vue` confirms pagination verification comment
- `quasar build` succeeds
- All 4 PRF requirements addressed: PRF-01 (lazy charts), PRF-02 (Firebase Performance), PRF-03 (listener cleanup), PRF-04 (pagination boundary)
</verification>

<success_criteria>
- PRF-01: Dashboard charts lazy-loaded with intersection observer
- PRF-03: Listener cleanup on team switch verified and documented (already implemented in Phase 02)
- PRF-04: Pagination boundary enforcement verified and documented (already implemented in original codebase)
- No regressions -- existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/06-performance/06-02-SUMMARY.md`
</output>
