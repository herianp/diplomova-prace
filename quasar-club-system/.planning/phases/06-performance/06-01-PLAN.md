---
phase: 06-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/firebase/config.ts
  - index.html
  - src/composables/useChartLazyLoad.ts
  - src/components/reports/ReportsCharts.vue
autonomous: true
user_setup: []

must_haves:
  truths:
    - "ReportsCharts renders Chart.js canvases only when their card scrolls into viewport"
    - "Firebase Performance Monitoring auto-tracks page load times and web vitals in Firebase Console"
    - "Charts show q-skeleton placeholders before entering viewport (no layout shift)"
    - "Chart.js destroy() called on unmount prevents memory leaks"
  artifacts:
    - path: "src/composables/useChartLazyLoad.ts"
      provides: "Reusable intersection observer composable for lazy chart rendering"
      exports: ["useChartLazyLoad"]
    - path: "src/firebase/config.ts"
      provides: "Firebase Performance Monitoring initialization"
      exports: ["analytics", "db", "auth", "perf"]
    - path: "src/components/reports/ReportsCharts.vue"
      provides: "Lazy-loaded Chart.js charts using intersection observer"
      contains: "useChartLazyLoad"
  key_links:
    - from: "src/components/reports/ReportsCharts.vue"
      to: "src/composables/useChartLazyLoad.ts"
      via: "import useChartLazyLoad"
      pattern: "useChartLazyLoad"
    - from: "src/firebase/config.ts"
      to: "firebase/performance"
      via: "getPerformance import"
      pattern: "getPerformance"
---

<objective>
Install VueUse, initialize Firebase Performance Monitoring, create lazy chart composable, and integrate lazy rendering into ReportsCharts.vue.

Purpose: ReportsCharts.vue creates 4 Chart.js instances simultaneously on mount, blocking the main thread. Lazy loading defers chart creation to viewport entry, reducing initial page load time. Firebase Performance provides baseline web vitals monitoring.

Output: useChartLazyLoad composable, Firebase Performance init, ReportsCharts with lazy-rendered charts.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-performance/06-RESEARCH.md
@src/firebase/config.ts
@src/components/reports/ReportsCharts.vue
@src/composables/useChartLazyLoad.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install VueUse and initialize Firebase Performance Monitoring</name>
  <files>package.json, src/firebase/config.ts, index.html</files>
  <action>
1. Run `yarn add @vueuse/core` to install VueUse (not currently in package.json).

2. Edit `src/firebase/config.ts`:
   - Add import: `import { getPerformance } from "firebase/performance"`
   - After `const auth = getAuth(app)`, add: `const perf = getPerformance(app)`
   - Update export: `export { analytics, db, auth, perf }`
   - Add a brief JSDoc comment: "Initialize Performance Monitoring (automatic web vitals: FCP, LCP, CLS, FID)"

3. Edit `index.html`:
   - Add before the closing `</head>` tag: `<script defer src="https://unpkg.com/first-input-delay"></script>`
   - Add comment: "FID polyfill for Firebase Performance Monitoring"

Do NOT add custom traces yet -- automatic web vitals tracking is sufficient for PRF-02.
  </action>
  <verify>
Run `yarn list @vueuse/core` and confirm it shows a version (10.x+).
Run `npx tsc --noEmit src/firebase/config.ts` or `quasar build` to confirm no type errors.
Grep for `getPerformance` in config.ts to confirm it is present.
  </verify>
  <done>
@vueuse/core installed, Firebase Performance initialized in config.ts exporting `perf`, FID polyfill script in index.html.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useChartLazyLoad composable and integrate into ReportsCharts</name>
  <files>src/composables/useChartLazyLoad.ts, src/components/reports/ReportsCharts.vue</files>
  <action>
1. Create `src/composables/useChartLazyLoad.ts`:
   - Import `ref`, `onUnmounted` from vue, `useIntersectionObserver` from `@vueuse/core`
   - Export function `useChartLazyLoad()` that returns `{ chartContainer: Ref<HTMLElement | null>, isVisible: Ref<boolean>, hasRendered: Ref<boolean> }`
   - Inside: create `chartContainer` ref, `isVisible` ref (false), `hasRendered` ref (false)
   - Call `useIntersectionObserver(chartContainer, callback, { threshold: 0.1, rootMargin: '50px' })`
   - Callback: if `entry.isIntersecting && !hasRendered.value`, set both `isVisible` and `hasRendered` to true, call `stop()`
   - In `onUnmounted`, call `stop()` as safety cleanup
   - Use TypeScript with proper Ref types from vue

2. Edit `src/components/reports/ReportsCharts.vue`:
   - Import `useChartLazyLoad` from `@/composables/useChartLazyLoad`
   - Create 4 instances for each chart section:
     ```
     const { chartContainer: participationContainer, isVisible: participationVisible } = useChartLazyLoad()
     const { chartContainer: typesContainer, isVisible: typesVisible } = useChartLazyLoad()
     const { chartContainer: trendContainer, isVisible: trendVisible } = useChartLazyLoad()
     const { chartContainer: rankingContainer, isVisible: rankingVisible } = useChartLazyLoad()
     ```
   - For each chart card in template:
     - Add `ref="participationContainer"` (etc.) on the outer `<div>` wrapping the card
     - Replace the `<canvas ref="participationChart">` with:
       ```
       <canvas v-if="participationVisible" ref="participationChart"></canvas>
       <q-skeleton v-else type="rect" height="400px" />
       ```
     - Apply same pattern for all 4 charts (typesVisible, trendVisible, rankingVisible) with matching heights (400px for participation/ranking, 300px for types/trend)

   - Update chart creation watchers:
     - Add a watch on each `isVisible` ref to trigger chart creation when it becomes true:
       ```
       watch(participationVisible, async (visible) => {
         if (visible) {
           await nextTick()
           createParticipationChart()
         }
       })
       ```
     - Do same for all 4 charts

   - Keep existing `destroyAllCharts()` in `onUnmounted` -- it already correctly calls chart.destroy()

   - Keep existing watchers for `filteredSurveys` and `selectedPlayer` -- they recreate charts when data changes, but only if the chart canvas exists (existing guard `if (!participationChart.value) return` handles this)

   - Remove or adjust the `onMounted` chart creation since charts will now be created by intersection observer. The existing `watch(() => props.loading, ...)` should also be updated: only create charts that are currently visible.

Important: The `createAllCharts()` function should be updated to only create charts whose container is visible:
```
const createAllCharts = async () => {
  await nextTick()
  await nextTick()
  if (participationVisible.value) createParticipationChart()
  if (typesVisible.value) createSurveyTypesChart()
  if (trendVisible.value) createMonthlyTrendChart()
  if (rankingVisible.value) createPlayerRankingChart()
}
```
  </action>
  <verify>
Run `quasar build` to confirm no compilation errors.
Open the app in browser, navigate to Reports page. Verify:
- Top chart (participation) renders immediately (already in viewport)
- Bottom charts show skeleton placeholders until scrolled into view
- Scrolling down triggers chart rendering with no flicker
- Charts still update when changing filters or selected player
  </verify>
  <done>
useChartLazyLoad composable created with intersection observer pattern. ReportsCharts.vue uses 4 independent lazy load instances -- charts render on viewport entry with skeleton placeholders, no simultaneous Chart.js instantiation on mount. Existing chart destroy cleanup preserved.
  </done>
</task>

</tasks>

<verification>
- `yarn list @vueuse/core` shows installed version
- `grep -r "getPerformance" src/firebase/config.ts` confirms Firebase Performance init
- `grep -r "useChartLazyLoad" src/components/reports/` confirms composable integration
- `grep -r "q-skeleton" src/components/reports/ReportsCharts.vue` confirms skeleton placeholders
- `quasar build` succeeds with no errors
</verification>

<success_criteria>
- PRF-01: Charts in ReportsCharts.vue render lazily via intersection observer (not all 4 on mount)
- PRF-02: Firebase Performance Monitoring initialized, automatic web vitals tracking active
- No TypeScript or build errors introduced
- Chart.js destroy() cleanup preserved in onUnmounted
</success_criteria>

<output>
After completion, create `.planning/phases/06-performance/06-01-SUMMARY.md`
</output>
