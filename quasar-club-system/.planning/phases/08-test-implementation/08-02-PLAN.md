---
phase: 08-test-implementation
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/composable/__tests__/useAuthUseCases.test.ts
autonomous: true

must_haves:
  truths:
    - "Auth signIn success test sets authStore.user and resolves"
    - "Auth signIn failure test sets authStore.user to null and calls notifyError"
    - "Auth signOut test clears authStore.user and teamStore data"
    - "Auth initializeAuth test sets authStore.isAuthReady=true and registers auth listener"
    - "Auth signUp test registers user and sets authStore.user"
  artifacts:
    - path: "src/composable/__tests__/useAuthUseCases.test.ts"
      provides: "Auth flow unit tests covering TST-03"
      contains: "useAuthUseCases"
  key_links:
    - from: "src/composable/__tests__/useAuthUseCases.test.ts"
      to: "src/composable/useAuthUseCases.ts"
      via: "imports and tests"
      pattern: "useAuthUseCases"
---

<objective>
Write unit tests for useAuthUseCases composable covering TST-03: login, register, logout, permission denied, and session persistence scenarios.

Purpose: Verifies auth flow business logic (store updates, error handling, router navigation) without touching Firebase.
Output: Passing auth use case tests with mocked Firebase services, Pinia stores, and vue-router.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/composable/useAuthUseCases.ts
@src/stores/authStore.ts
@src/services/authFirebase.ts
@src/errors/index.ts
@src/composable/__tests__/useDateHelpers.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write useAuthUseCases unit tests with full mock setup</name>
  <files>src/composable/__tests__/useAuthUseCases.test.ts</files>
  <action>
Create test file with these mocks at the top (vi.mock calls are hoisted):

1. **Mock @/firebase/config** — prevent initializeApp side effects:
   ```typescript
   vi.mock('@/firebase/config', () => ({ db: {}, auth: {}, analytics: {}, perf: {} }))
   ```

2. **Mock vue-router** — capture router.push calls:
   ```typescript
   const mockPush = vi.fn()
   vi.mock('vue-router', () => ({ useRouter: () => ({ push: mockPush }) }))
   ```

3. **Mock @/services/notificationService** — capture error notifications:
   ```typescript
   vi.mock('@/services/notificationService', () => ({ notifyError: vi.fn(), notifySuccess: vi.fn() }))
   ```

4. **Mock src/utils/logger** — suppress log output:
   ```typescript
   vi.mock('src/utils/logger', () => ({
     createLogger: () => ({ debug: vi.fn(), info: vi.fn(), warn: vi.fn(), error: vi.fn() })
   }))
   ```

5. **Mock @/services/authFirebase** — control all Firebase auth calls:
   ```typescript
   const mockLoginUser = vi.fn()
   const mockLogoutUser = vi.fn()
   const mockRegisterUser = vi.fn()
   const mockAuthStateListener = vi.fn()
   const mockAuthStateReady = vi.fn()
   const mockGetCurrentUser = vi.fn()
   const mockRefreshUser = vi.fn()
   vi.mock('@/services/authFirebase', () => ({
     useAuthFirebase: () => ({
       loginUser: mockLoginUser,
       logoutUser: mockLogoutUser,
       registerUser: mockRegisterUser,
       authStateListener: mockAuthStateListener,
       authStateReady: mockAuthStateReady,
       getCurrentUser: mockGetCurrentUser,
       refreshUser: mockRefreshUser
     })
   }))
   ```

6. **Mock @/services/listenerRegistry** — prevent singleton side effects:
   ```typescript
   vi.mock('@/services/listenerRegistry', () => ({
     listenerRegistry: { register: vi.fn(), unregister: vi.fn(), unregisterAll: vi.fn() }
   }))
   ```

7. **Mock @/composable/useTeamUseCases** — prevent team listener setup:
   ```typescript
   const mockSetTeamListener = vi.fn()
   vi.mock('@/composable/useTeamUseCases', () => ({
     useTeamUseCases: () => ({ setTeamListener: mockSetTeamListener })
   }))
   ```

8. **Pinia setup** in beforeEach:
   ```typescript
   import { setActivePinia, createPinia } from 'pinia'
   beforeEach(() => {
     setActivePinia(createPinia())
     vi.clearAllMocks()
   })
   ```

**Test cases for TST-03:**

**signIn:**
- success: loginUser resolves with mock user → authStore.user is set, loading goes false, returns user
- failure (AuthError): loginUser rejects with AuthError('auth/wrong-password', 'Wrong password') → authStore.user is null, notifyError called with error message, loading goes false, error re-thrown
- failure (network error): loginUser rejects with AuthError('auth/network-request-failed', 'Network error') → notifyError called with retry option
- failure (generic error): loginUser rejects with Error → notifyError called with 'errors.unexpected'

**signUp:**
- success: registerUser resolves with mock user → authStore.user set, loading goes false
- failure: registerUser rejects with AuthError → authStore.user null, notifyError called, error re-thrown

**signOut:**
- success: logoutUser resolves → authStore.user null, teamStore.clearData called
- failure: logoutUser rejects with AuthError → notifyError called, error re-thrown

**initializeAuth:**
- with null user: authStateReady resolves null → authStore.isAuthReady set true, no team listener setup
- with user: authStateReady resolves mock user (with getIdTokenResult returning { claims: {} }) → authStore.user set, authReady true
- with admin user: authStateReady resolves user with admin claim → authStore.setAdmin(true) called
- auth listener registered: authStateListener called, listenerRegistry.register called with 'auth'

**session persistence (page reload):**
- Capture the callback passed to `mockAuthStateListener` (e.g., `mockAuthStateListener.mockImplementation((callback) => { capturedCallback = callback; return vi.fn() })`). After `initializeAuth` completes, invoke `capturedCallback(createMockUser())` to simulate auth state firing on page reload. Verify `authStore.setUser` called with the user and `setTeamListener` called. This covers TST-03's "session persistence" scenario.

**refreshCurrentUser:**
- success: refreshUser resolves with user → authStore.user updated
- failure: refreshUser rejects → notifyError called

Create a mock User object factory:
```typescript
const createMockUser = (overrides = {}) => ({
  uid: 'test-uid',
  email: 'test@test.cz',
  displayName: 'Test User',
  getIdTokenResult: vi.fn().mockResolvedValue({ claims: {} }),
  ...overrides
})
```

Import AuthError from @/errors for error testing. Use `await expect(promise).rejects.toThrow()` pattern for error cases.
  </action>
  <verify>Run `yarn vitest run src/composable/__tests__/useAuthUseCases.test.ts` — all tests pass.</verify>
  <done>Auth flow tests verify: signIn success/failure (3 error types), signUp success/failure, signOut success/failure, initializeAuth with null/user/admin, refreshCurrentUser success/failure, listener registration. At least 12 test cases covering TST-03 requirements.</done>
</task>

</tasks>

<verification>
1. `yarn vitest run` passes all tests including new auth tests
2. Auth tests cover login success + 3 failure types (wrong password, network, generic)
3. Auth tests cover register success + failure
4. Auth tests cover logout success + failure
5. Auth tests cover initializeAuth with null user, regular user, admin user
6. Auth tests verify listenerRegistry.register called for auth listener
</verification>

<success_criteria>
- All auth use case tests pass
- signIn, signUp, signOut, initializeAuth, refreshCurrentUser all tested
- Error handling verified for AuthError and generic errors
- Store state mutations verified (user set/cleared, loading toggled, admin set)
- Router navigation verified via auth listener callback (push to HOME on null user), not in signOut directly
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-implementation/08-02-SUMMARY.md`
</output>
