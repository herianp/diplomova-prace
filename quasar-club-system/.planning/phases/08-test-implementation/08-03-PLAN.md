---
phase: 08-test-implementation
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/composable/__tests__/useSurveyUseCases.vote.test.ts
  - src/composable/__tests__/useCashboxUseCases.test.ts
autonomous: true

must_haves:
  truths:
    - "voteOnSurvey calls addOrUpdateVote when survey exists in store"
    - "voteOnSurvey does nothing when survey not found in store"
    - "voteOnSurvey handles Firebase errors with notifyError"
    - "generateAutoFines creates fines for NO_ATTENDANCE trigger"
    - "generateAutoFines creates fines for VOTED_YES_BUT_ABSENT trigger"
    - "generateAutoFines creates fines for UNVOTED trigger"
    - "generateAutoFines skips rules that don't match survey type"
    - "generateAutoFines returns 0 when no active rules exist"
  artifacts:
    - path: "src/composable/__tests__/useSurveyUseCases.vote.test.ts"
      provides: "Survey voting unit tests covering TST-04"
      contains: "voteOnSurvey"
    - path: "src/composable/__tests__/useCashboxUseCases.test.ts"
      provides: "Cashbox fine rule tests covering TST-05"
      contains: "generateAutoFines"
  key_links:
    - from: "src/composable/__tests__/useSurveyUseCases.vote.test.ts"
      to: "src/composable/useSurveyUseCases.ts"
      via: "imports and tests voteOnSurvey"
      pattern: "voteOnSurvey"
    - from: "src/composable/__tests__/useCashboxUseCases.test.ts"
      to: "src/composable/useCashboxUseCases.ts"
      via: "imports and tests generateAutoFines"
      pattern: "generateAutoFines"
---

<objective>
Write unit tests for survey voting (TST-04) and cashbox fine rule evaluation (TST-05).

Purpose: Tests the two most business-critical flows — voting on surveys and automatic fine generation — with all Firebase services mocked.
Output: Passing tests for voteOnSurvey edge cases and all 3 FineRuleTrigger types.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/composable/useSurveyUseCases.ts
@src/composable/useCashboxUseCases.ts
@src/interfaces/interfaces.ts
@src/enums/SurveyTypes.ts
@src/composable/__tests__/useDateHelpers.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write survey voting tests (TST-04)</name>
  <files>src/composable/__tests__/useSurveyUseCases.vote.test.ts</files>
  <action>
Create test file with these mocks:

1. **Mock @/firebase/config** — prevent initializeApp:
   ```typescript
   vi.mock('@/firebase/config', () => ({ db: {}, auth: {}, analytics: {}, perf: {} }))
   ```

2. **Mock @/services/notificationService**:
   ```typescript
   vi.mock('@/services/notificationService', () => ({ notifyError: vi.fn(), notifySuccess: vi.fn() }))
   ```

3. **Mock src/utils/logger**:
   ```typescript
   vi.mock('src/utils/logger', () => ({
     createLogger: () => ({ debug: vi.fn(), info: vi.fn(), warn: vi.fn(), error: vi.fn() })
   }))
   ```

4. **Mock @/services/listenerRegistry**:
   ```typescript
   vi.mock('@/services/listenerRegistry', () => ({
     listenerRegistry: { register: vi.fn(), unregister: vi.fn(), unregisterAll: vi.fn() }
   }))
   ```

5. **Mock @/services/surveyFirebase** — control addOrUpdateVote:
   ```typescript
   const mockAddOrUpdateVote = vi.fn()
   const mockGetSurveysByTeamId = vi.fn()
   vi.mock('@/services/surveyFirebase', () => ({
     useSurveyFirebase: () => ({
       addOrUpdateVote: mockAddOrUpdateVote,
       getSurveysByTeamId: mockGetSurveysByTeamId,
       getSurveyById: vi.fn(),
       addSurvey: vi.fn(),
       updateSurvey: vi.fn(),
       deleteSurvey: vi.fn(),
       updateSurveyStatus: vi.fn(),
       verifySurvey: vi.fn(),
       updateSurveyVotes: vi.fn()
     })
   }))
   ```

6. **Mock @/composable/useNotificationsComposable**:
   ```typescript
   vi.mock('@/composable/useNotificationsComposable', () => ({
     useNotifications: () => ({ createSurveyNotification: vi.fn() })
   }))
   ```

7. **Mock firebase/firestore** (for getDoc/doc used in addSurvey):
   ```typescript
   vi.mock('firebase/firestore', () => ({
     getDoc: vi.fn(),
     doc: vi.fn()
   }))
   ```

8. **Pinia setup**: `setActivePinia(createPinia())` in beforeEach, then pre-populate teamStore.

**Test cases for TST-04 (voteOnSurvey):**

- **New vote (survey exists)**: Pre-populate `teamStore.surveys` with `[{ id: 'survey-1', votes: [], teamId: 't1' }]`. Call `voteOnSurvey('survey-1', 'user-1', true)`. Verify `mockAddOrUpdateVote` called with `('survey-1', 'user-1', true, [])`.

- **Update vote (user already voted)**: Pre-populate surveys with existing vote `[{ userUid: 'user-1', vote: false }]`. Call `voteOnSurvey('survey-1', 'user-1', true)`. Verify `mockAddOrUpdateVote` called with updated vote value and the existing votes array.

- **Survey not in store**: Leave `teamStore.surveys` empty. Call `voteOnSurvey('nonexistent', 'user-1', true)`. Verify `mockAddOrUpdateVote` NOT called.

- **Firebase error (FirestoreError)**: Make `mockAddOrUpdateVote.mockRejectedValueOnce(new FirestoreError('unavailable', 'write', 'Service unavailable'))`. Pre-populate surveys. Call `voteOnSurvey(...)`. Verify `notifyError` called with error message and retry option. Verify error re-thrown.

- **Firebase error (generic)**: Make `mockAddOrUpdateVote.mockRejectedValueOnce(new Error('unknown'))`. Verify `notifyError` called with 'errors.unexpected'.

- **Transient error has retry**: Make mock reject with `new FirestoreError('unavailable', 'write', 'Service unavailable')`. Verify notifyError called with `{ retry: true, onRetry: expect.any(Function) }`.

- **Permanent error no retry**: Make mock reject with `new FirestoreError('permission-denied', 'write', 'Permission denied')`. Verify notifyError called WITHOUT retry option (shouldRetry is false because 'permission-denied' is not 'unavailable' or 'deadline-exceeded').

Import FirestoreError from @/errors for error construction.
  </action>
  <verify>Run `yarn vitest run src/composable/__tests__/useSurveyUseCases.vote.test.ts` — all tests pass.</verify>
  <done>Survey voting tests cover: new vote, update vote, survey not found, Firebase errors (transient with retry, permanent without retry, generic).</done>
</task>

<task type="auto">
  <name>Task 2: Write cashbox fine rule tests (TST-05)</name>
  <files>src/composable/__tests__/useCashboxUseCases.test.ts</files>
  <action>
Create test file with these mocks:

1. **Mock @/firebase/config**:
   ```typescript
   vi.mock('@/firebase/config', () => ({ db: {}, auth: {}, analytics: {}, perf: {} }))
   ```

2. **Mock @/services/notificationService**:
   ```typescript
   vi.mock('@/services/notificationService', () => ({ notifyError: vi.fn(), notifySuccess: vi.fn() }))
   ```

3. **Mock src/utils/logger**:
   ```typescript
   vi.mock('src/utils/logger', () => ({
     createLogger: () => ({ debug: vi.fn(), info: vi.fn(), warn: vi.fn(), error: vi.fn() })
   }))
   ```

4. **Mock @/services/cashboxFirebase** — control loadFineRules and bulkAddFines:
   ```typescript
   const mockLoadFineRules = vi.fn()
   const mockBulkAddFines = vi.fn()
   vi.mock('@/services/cashboxFirebase', () => ({
     useCashboxFirebase: () => ({
       loadFineRules: mockLoadFineRules,
       bulkAddFines: mockBulkAddFines,
       listenToFineRules: vi.fn(),
       listenToFines: vi.fn(),
       listenToPayments: vi.fn(),
       addFineRule: vi.fn(),
       updateFineRule: vi.fn(),
       deleteFineRule: vi.fn(),
       addFine: vi.fn(),
       deleteFine: vi.fn(),
       addPayment: vi.fn(),
       deletePayment: vi.fn(),
       listenToCashboxHistory: vi.fn()
     })
   }))
   ```

5. **Pinia setup**: `setActivePinia(createPinia())` in beforeEach, `vi.clearAllMocks()`.

Import `FineRuleTrigger` and `SurveyTypes` from project enums/interfaces.

Create helper to build fine rules:
```typescript
const createRule = (overrides = {}) => ({
  id: 'rule-1',
  name: 'Test Rule',
  amount: 50,
  triggerType: FineRuleTrigger.NO_ATTENDANCE,
  active: true,
  surveyType: undefined,
  ...overrides
})
```

**Test cases for TST-05 (generateAutoFines):**

**Trigger type: NO_ATTENDANCE**
- Player verified vote is false → fine created
- Player verified vote is true → no fine
- Multiple players, one with vote=false → exactly 1 fine

**Trigger type: VOTED_YES_BUT_ABSENT**
- Original vote=true, verified vote=false → fine created
- Original vote=true, no verified vote → fine created
- Original vote=false, verified vote=false → no fine (didn't originally vote yes)
- Original vote=true, verified vote=true → no fine (not absent)

**Trigger type: UNVOTED**
- No verified vote entry for member → fine created
- Verified vote exists (true or false) → no fine

**Edge cases:**
- No active rules: mockLoadFineRules returns `[]` → returns 0, bulkAddFines NOT called
- Inactive rules filtered: mockLoadFineRules returns `[{ ...rule, active: false }]` → returns 0
- Survey type filter: rule has `surveyType: SurveyTypes.Training`, survey is `SurveyTypes.Match` → skip rule, no fine
- Survey type match: rule has `surveyType: SurveyTypes.Training`, survey IS Training → fine generated normally
- Rule without surveyType filter: rule has `surveyType: undefined` → applies to all survey types
- Multiple rules, multiple members: 2 rules + 3 members → correct number of fines generated
- Empty votes arrays: originalVotes=[], verifiedVotes=[] → UNVOTED fires for all members
- Fine reason format: verify `bulkAddFines` called with fines having reason format `${rule.name} — ${surveyTitle}`
- Fine source: verify fines have `source: 'auto'`
- Return value: verify returns count of created fines

Common call pattern for generateAutoFines:
```typescript
const { generateAutoFines } = useCashboxUseCases()
const count = await generateAutoFines(
  'team-1',        // teamId
  'survey-1',      // surveyId
  'Training Wed',  // surveyTitle
  SurveyTypes.Training,  // surveyType
  originalVotes,   // IVote[]
  verifiedVotes,   // IVote[]
  ['player-1'],    // teamMemberIds
  'admin-uid'      // createdBy
)
```
  </action>
  <verify>Run `yarn vitest run src/composable/__tests__/useCashboxUseCases.test.ts` — all tests pass.</verify>
  <done>Cashbox fine rule tests cover all 3 FineRuleTrigger types (NO_ATTENDANCE, VOTED_YES_BUT_ABSENT, UNVOTED), survey type filtering, inactive rule filtering, empty votes arrays, multiple rules + multiple members, fine creation format, and return value.</done>
</task>

</tasks>

<verification>
1. `yarn vitest run` passes all tests (existing + survey + cashbox)
2. Survey voting tests cover: vote success, survey not found, Firebase errors with retry logic
3. Cashbox tests cover: all 3 FineRuleTrigger types, edge cases (inactive rules, type filter, empty votes)
4. `yarn vitest run --coverage` shows increased coverage over composable files
</verification>

<success_criteria>
- All survey voting tests pass (7+ test cases)
- All cashbox fine rule tests pass (12+ test cases)
- voteOnSurvey error handling verified (transient vs permanent errors)
- generateAutoFines verified for all 3 trigger types + edge cases
- Coverage for useSurveyUseCases and useCashboxUseCases > 50% (voting and generateAutoFines are tested, other methods are not primary targets)
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-implementation/08-03-SUMMARY.md`
</output>
