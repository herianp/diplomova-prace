---
phase: 12-team-discovery-join-requests
plan: "03"
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/components/team/JoinRequestManagement.vue
  - src/components/new/CustomDrawer.vue
  - src/stores/teamStore.ts
  - src/composable/useTeamUseCases.ts
  - src/i18n/en-US/index.ts
  - src/i18n/cs-CZ/index.ts
autonomous: true
requirements:
  - DISC-03
  - DISC-04
  - DISC-05

must_haves:
  truths:
    - "A team power user sees a notification badge on a sidebar menu item when pending join requests exist"
    - "A power user can view a list of pending join requests with user name, email, and approve/decline buttons"
    - "Approving a request adds the user to the team members array and updates request status to approved"
    - "Declining a request updates status to declined without adding user to team"
    - "Approve/decline actions are audited and visible on admin page"
  artifacts:
    - path: "src/components/team/JoinRequestManagement.vue"
      provides: "Power user view of pending join requests with approve/decline"
      min_lines: 60
    - path: "src/components/new/CustomDrawer.vue"
      provides: "Sidebar with badge count for pending join requests"
      contains: "q-badge"
    - path: "src/stores/teamStore.ts"
      provides: "Reactive state for pending join requests count"
      contains: "pendingJoinRequests"
  key_links:
    - from: "src/components/team/JoinRequestManagement.vue"
      to: "src/composable/useJoinRequestUseCases.ts"
      via: "approve/decline method calls"
      pattern: "approveJoinRequest|declineJoinRequest"
    - from: "src/components/new/CustomDrawer.vue"
      to: "src/stores/teamStore.ts"
      via: "badge reads pending count from store"
      pattern: "pendingJoinRequests"
---

<objective>
Build the power user join request management UI: a sidebar badge for pending requests, a management component with approve/decline, and wiring to the team store for real-time badge counts.

Purpose: Enables DISC-03 (power user sees pending requests), DISC-04 (approve/decline), and DISC-05 (approved user added to members). Completes the power user side of the join request flow.

Output: Working power user request management accessible from sidebar badge and teams page.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-team-discovery-join-requests/12-CONTEXT.md
@.planning/phases/12-team-discovery-join-requests/12-01-SUMMARY.md
@src/components/new/CustomDrawer.vue
@src/stores/teamStore.ts
@src/composable/useTeamUseCases.ts
@src/services/auditLogFirebase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pending join requests state to teamStore and set up listener in useTeamUseCases</name>
  <files>
    src/stores/teamStore.ts
    src/composable/useTeamUseCases.ts
  </files>
  <action>
**1. In `src/stores/teamStore.ts`:**

Add new state for pending join requests. Follow the existing Setup Store pattern:

- Add `import { IJoinRequest } from '@/interfaces/interfaces'` (if ITeam is already imported, add IJoinRequest to that import)
- Add `pendingJoinRequests` ref: `const pendingJoinRequests = ref<IJoinRequest[]>([])`
- Add setter: `const setPendingJoinRequests = (requests: IJoinRequest[]) => { pendingJoinRequests.value = requests }`
- Add computed: `const pendingJoinRequestCount = computed(() => pendingJoinRequests.value.length)`
- Export in the return statement: `pendingJoinRequests`, `setPendingJoinRequests`, `pendingJoinRequestCount`
- In the existing `clearData()` function, add: `pendingJoinRequests.value = []`

**2. In `src/composable/useTeamUseCases.ts`:**

Add a method to set up the pending join requests listener for the current team. This listener should be scoped to the 'team' scope so it gets cleaned up on team switch (same as surveys listener).

- Import `useJoinRequestFirebase` from `@/services/joinRequestFirebase`
- Add `setPendingJoinRequestsListener(teamId: string)` method:
  - Get `joinRequestFirebase` from `useJoinRequestFirebase()`
  - Check if current user is a power user of the team (check `teamStore.currentTeam?.powerusers?.includes(authStore.user?.uid)`)
  - If not power user, set `teamStore.setPendingJoinRequests([])` and return (no listener needed)
  - If power user, call `joinRequestFirebase.getJoinRequestsByTeam(teamId, (requests) => teamStore.setPendingJoinRequests(requests))`
  - Register the unsubscribe with `listenerRegistry.register('pendingJoinRequests', unsubscribe, { teamId })` using scope 'team' so it cleans up on team switch
- Export `setPendingJoinRequestsListener` in the return object

The listener should be called from the same place where `setSurveysListener` is called (likely in CustomDrawer's `selectTeam` or during initial team setup). For simplicity, call it inside the existing `setTeamListener` callback after the first team is auto-selected, or add it alongside existing listener setup.

Actually, the cleanest approach: call `setPendingJoinRequestsListener` in the `selectTeam` function in CustomDrawer.vue alongside `setSurveysListener`, AND also call it in `setTeamListener` when currentTeam is first auto-selected.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` to check TypeScript. Verify teamStore exports `pendingJoinRequests` and `pendingJoinRequestCount`. Verify useTeamUseCases exports `setPendingJoinRequestsListener`.
  </verify>
  <done>teamStore has pendingJoinRequests state with setter and computed count. useTeamUseCases has setPendingJoinRequestsListener that only activates for power users and registers with listener registry.</done>
</task>

<task type="auto">
  <name>Task 2: Create JoinRequestManagement component and add sidebar badge</name>
  <files>
    src/components/team/JoinRequestManagement.vue
    src/components/new/CustomDrawer.vue
    src/i18n/en-US/index.ts
    src/i18n/cs-CZ/index.ts
  </files>
  <action>
**1. Create `src/components/team/JoinRequestManagement.vue`:**

A component that shows pending join requests for the current team with approve/decline actions. Used inside the TeamsPage or as a dialog/section.

**Props:** none (reads from teamStore)

**Template:**
- Header: `q-item-label` with "Join Requests" title and `q-badge` showing count
- `q-list` with separator, iterating `pendingJoinRequests` from teamStore:
  - `q-item` per request:
    - `q-item-section avatar`: `q-avatar` with first letter of user name
    - `q-item-section`: `q-item-label` showing `request.userDisplayName`, `q-item-label caption` showing `request.userEmail`
    - `q-item-section side`:
      - `q-btn` flat dense icon "check" color="positive" @click `approve(request)` with tooltip "Approve"
      - `q-btn` flat dense icon "close" color="negative" @click `decline(request)` with tooltip "Decline"
- Empty state: message "No pending join requests" when list is empty
- Loading spinner during approve/decline operations

**Script setup:**
- Import `useJoinRequestUseCases` and `useTeamStore`
- `pendingJoinRequests` computed from `teamStore.pendingJoinRequests`
- `isProcessing` ref for loading state during approve/decline
- `approve(request)` — sets isProcessing, calls `useJoinRequestUseCases().approveJoinRequest(request)`, shows success toast, unsets isProcessing
- `decline(request)` — sets isProcessing, calls `useJoinRequestUseCases().declineJoinRequest(request)`, shows info toast, unsets isProcessing
- Error handling with try/catch and `$q.notify` for error toasts

**2. Update `src/components/new/CustomDrawer.vue`:**

Add a badge to the "Teams" navigation link showing the pending join request count.

- Import `useTeamStore` (already imported) and `useTeamUseCases`
- Access `pendingJoinRequestCount` computed from teamStore
- Find the "Teams" entry in `topLinks` array. Instead of using the simple v-for pattern for Teams, add a special rendering for the Teams link that includes a `q-badge`:

In the navigation list rendering, check if the link is "Teams" and conditionally add a floating badge:
```html
<q-item-section side v-if="link.route === RouteEnum.TEAM.path && pendingJoinRequestCount > 0">
  <q-badge color="red" floating>{{ pendingJoinRequestCount }}</q-badge>
</q-item-section>
```

Alternatively, add a `badge` property to the topLinks entry and render it conditionally. The cleanest approach: modify the v-for to include an optional badge section.

- Also in CustomDrawer's `selectTeam` function, after `setSurveysListener(team.id)`, add:
```javascript
const { setPendingJoinRequestsListener } = useTeamUseCases()
setPendingJoinRequestsListener(team.id)
```

This ensures the badge updates when switching teams.

**3. Add i18n translations:**

In both language files, add a `joinRequests` block (at root level alongside existing sections):

English:
```
joinRequests: {
  title: 'Join Requests',
  approve: 'Approve',
  decline: 'Decline',
  approved: '{name} has been added to the team',
  declined: 'Request from {name} declined',
  noRequests: 'No pending join requests',
  pendingCount: '{count} pending request | {count} pending requests'
}
```

Czech:
```
joinRequests: {
  title: 'Zadosti o prirazeni',
  approve: 'Schvalit',
  decline: 'Zamitnout',
  approved: '{name} byl pridan do tymu',
  declined: 'Zadost od {name} zamitnuta',
  noRequests: 'Zadne nevyrizene zadosti',
  pendingCount: '{count} nevyrizena zadost | {count} nevyrizene zadosti | {count} nevyrizenych zadosti'
}
```

Use proper Czech diacritics matching existing translation style.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30`. Verify JoinRequestManagement.vue exists with approve/decline functionality. Verify CustomDrawer.vue contains badge rendering logic. Check i18n files contain joinRequests block.
  </verify>
  <done>JoinRequestManagement.vue renders pending requests with approve/decline buttons. CustomDrawer shows red badge on Teams link when pending requests exist. Approve adds member to team and writes audit log. Decline updates status without adding member. Both actions show toast feedback.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors
2. teamStore.pendingJoinRequestCount is reactive and updates via listener
3. CustomDrawer "Teams" link shows red badge with count when pending > 0
4. JoinRequestManagement shows user name, email, approve/decline buttons
5. Approve adds user to team members array (verify via Firestore)
6. Decline updates status to 'declined' without adding user
7. Audit logs created for both approve and decline actions
8. Badge disappears when all requests are handled
9. i18n translations present in both languages
</verification>

<success_criteria>
- Sidebar badge is real-time reactive (Firestore listener via teamStore)
- Badge only shows for power users (listener skips for regular members)
- Approve/decline individual per-request (no bulk actions per CONTEXT.md)
- Audit trail created for approve/decline visible on admin page
- Listener registered with 'team' scope for proper cleanup on team switch
- All text internationalized
</success_criteria>

<output>
After completion, create `.planning/phases/12-team-discovery-join-requests/12-03-SUMMARY.md`
</output>
