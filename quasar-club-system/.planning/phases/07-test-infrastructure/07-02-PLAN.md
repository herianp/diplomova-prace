---
phase: 07-test-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - tests/rules/surveys.rules.test.ts
  - tests/rules/team-subcollections.rules.test.ts
  - tests/rules/invitations.rules.test.ts
  - tests/rules/notifications-messages.rules.test.ts
autonomous: true

must_haves:
  truths:
    - "Surveys collection rules tested: power user CRUD, member read, member vote-only update, non-member deny, admin access"
    - "Surveys votes subcollection rules tested: member read, own-vote create/update, power user full access, non-member deny"
    - "All team subcollections tested: cashboxTransactions, fineRules, fines, payments, cashboxHistory, auditLogs â€” member read, power user write, outsider deny"
    - "Team invitations rules tested: power user create, invitee read, invitee status update, power user delete, admin access"
    - "Notifications rules tested: own read/write, authenticated create, team creator delete"
    - "Messages rules tested: member read, power user create with authorId validation, team creator delete"
  artifacts:
    - path: "tests/rules/surveys.rules.test.ts"
      provides: "Surveys and votes subcollection rules tests"
      min_lines: 120
    - path: "tests/rules/team-subcollections.rules.test.ts"
      provides: "All team subcollection rules tests"
      min_lines: 100
    - path: "tests/rules/invitations.rules.test.ts"
      provides: "Team invitations rules tests"
      min_lines: 60
    - path: "tests/rules/notifications-messages.rules.test.ts"
      provides: "Notifications and messages rules tests"
      min_lines: 80
  key_links:
    - from: "all test files"
      to: "tests/rules/helpers/setup.ts"
      via: "import createTestEnv"
      pattern: "import.*createTestEnv.*from.*helpers/setup"
    - from: "all test files"
      to: "firestore.rules"
      via: "rules loaded by createTestEnv at runtime"
      pattern: "createTestEnv"
---

<objective>
Write security rules tests for all remaining Firestore collections: surveys (with votes subcollection), team subcollections (cashboxTransactions, fineRules, fines, payments, cashboxHistory, auditLogs), teamInvitations, notifications, and messages.

Purpose: Achieve full Firestore security rules coverage as required by TST-02, ensuring every collection has allow/deny tests for all permission scenarios.
Output: Four test files covering all collections, full test suite passes via yarn test:rules
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-test-infrastructure/07-RESEARCH.md
@.planning/phases/07-test-infrastructure/07-01-SUMMARY.md
@firestore.rules
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write surveys and votes subcollection rules tests</name>
  <files>tests/rules/surveys.rules.test.ts</files>
  <action>
    Create tests/rules/surveys.rules.test.ts.

    Use same pattern as established in 07-01 (import createTestEnv, lifecycle hooks with clearFirestore in afterEach).

    Constants:
    - TEAM_ID = 'team-001'
    - POWER_UID = 'power-uid'
    - MEMBER_UID = 'member-uid'
    - OUTSIDER_UID = 'outsider-uid'
    - SURVEY_ID = 'survey-001'

    Seed data in beforeEach:
    - teams/team-001: { name: 'FC Test', creator: POWER_UID, members: [POWER_UID, MEMBER_UID], powerusers: [POWER_UID] }
    - surveys/survey-001: { teamId: TEAM_ID, title: 'Match vs Sparta', date: '2026-03-01', votes: {} }

    describe('surveys - read'):
    - allows power user to read survey
    - allows team member to read survey
    - denies outsider read of survey
    - denies unauthenticated read of survey
    - allows app admin to read survey

    describe('surveys - create'):
    - allows power user to create survey (create new survey doc with teamId: TEAM_ID)
    - denies member (non-power) from creating survey

    describe('surveys - update'):
    - allows power user to update survey (any field)
    - allows member to update votes field (set request.resource.data.votes to non-null)
    - denies outsider update of survey

    describe('surveys - delete'):
    - allows power user to delete survey
    - allows app admin to delete survey
    - denies member (non-power) from deleting survey

    describe('surveys/votes subcollection - read'):
    - allows team member to read votes
    - denies outsider read of votes

    describe('surveys/votes subcollection - create/update'):
    - allows member to create own vote (voteId == auth.uid)
    - allows member to update own vote
    - denies member from creating vote with different voteId (voteId != auth.uid)
    - allows power user to create/update any vote

    describe('surveys/votes subcollection - delete'):
    - allows power user to delete vote
    - allows app admin to delete vote
    - denies member from deleting own vote (no delete rule for members)
  </action>
  <verify>
    Run: `firebase emulators:exec --only firestore,auth "yarn vitest run --config vitest.rules.config.ts tests/rules/surveys.rules.test.ts"`
    All tests pass.
  </verify>
  <done>
    surveys.rules.test.ts passes with full coverage: survey CRUD for power users, member read + vote update, votes subcollection ownership enforcement, admin access, outsider/unauth denial
  </done>
</task>

<task type="auto">
  <name>Task 2: Write team subcollections, invitations, notifications, and messages rules tests</name>
  <files>
    tests/rules/team-subcollections.rules.test.ts
    tests/rules/invitations.rules.test.ts
    tests/rules/notifications-messages.rules.test.ts
  </files>
  <action>
    **File 1: tests/rules/team-subcollections.rules.test.ts**

    Test all six team subcollections with a shared seed and parameterized pattern.
    The subcollections follow two patterns:
    - Pattern A (member read/write): cashboxTransactions
    - Pattern B (member read, power user write): fineRules, fines, payments, cashboxHistory

    Seed data: teams/team-001 with creator, members: [creator, power, member], powerusers: [creator, power]

    For each subcollection, use a describe block with:
    - allows member to read (MEMBER_UID)
    - denies outsider read (OUTSIDER_UID)
    - denies unauthenticated read

    Pattern A (cashboxTransactions):
    - allows member to write (MEMBER_UID)
    - allows admin read/delete

    Pattern B (fineRules, fines, payments, cashboxHistory):
    - allows power user to create/update/delete
    - denies member (non-power) from writing
    - allows admin read/delete

    For auditLogs subcollection (unique pattern):
    - allows power user to read
    - denies regular member from reading
    - allows authenticated member to create with matching teamId and actorUid == auth.uid
    - denies create with mismatched actorUid (actorUid != auth.uid)
    - denies create with mismatched teamId
    - allows admin read/delete
    - denies outsider from everything

    To keep the file manageable, use a helper function or loop for the Pattern B subcollections:
    ```typescript
    const patternBCollections = ['fineRules', 'fines', 'payments', 'cashboxHistory']
    for (const subcol of patternBCollections) {
      describe(`teams/${subcol}`, () => { ... })
    }
    ```

    **File 2: tests/rules/invitations.rules.test.ts**

    Constants: TEAM_ID, POWER_UID, INVITEE_UID = 'invitee-uid', OUTSIDER_UID

    Seed: teams/team-001, teamInvitations/invite-001: { teamId: TEAM_ID, inviteeId: INVITEE_UID, status: 'pending', invitedBy: POWER_UID }

    describe('teamInvitations - create'):
    - allows power user to create invitation (with valid teamId)
    - denies non-power-user from creating invitation

    describe('teamInvitations - read'):
    - allows invitee to read own invitation
    - allows power user to read team invitation
    - denies outsider from reading invitation

    describe('teamInvitations - update'):
    - allows invitee to accept invitation (update status to 'accepted')
    - allows invitee to decline invitation (update status to 'declined')
    - denies invitee from setting invalid status (e.g., 'cancelled')
    - denies outsider from updating invitation
    - denies update of already accepted invitation (seed with status: 'accepted')

    describe('teamInvitations - delete'):
    - allows power user to delete (cancel) invitation
    - denies invitee from deleting invitation
    - allows admin to delete invitation

    **File 3: tests/rules/notifications-messages.rules.test.ts**

    Seed: teams/team-001 with creator: CREATOR_UID, members: [CREATOR_UID, POWER_UID, MEMBER_UID], powerusers: [CREATOR_UID, POWER_UID]

    describe('notifications - own access'):
    - Seed notifications/notif-001: { userId: MEMBER_UID, teamId: TEAM_ID, message: 'test' }
    - allows owner to read own notification (MEMBER_UID)
    - allows owner to write own notification
    - denies other user from reading notification
    - denies unauthenticated read

    describe('notifications - create'):
    - allows any authenticated user to create notification

    describe('notifications - team creator/admin delete'):
    - allows team creator to delete notification
    - allows admin to delete notification
    - denies member (non-creator) from deleting other user notification

    describe('messages - read'):
    - Seed messages/msg-001: { teamId: TEAM_ID, authorId: POWER_UID, text: 'Hello', createdAt: new Date() }
    - allows team member to read message
    - denies outsider from reading message
    - denies unauthenticated read

    describe('messages - create'):
    - allows power user to create message with authorId == auth.uid
    - denies power user from creating message with authorId != auth.uid
    - denies regular member from creating message

    describe('messages - delete'):
    - allows team creator to delete message
    - allows admin to delete message
    - denies member from deleting message

    After writing all three files, run full suite:
    `firebase emulators:exec --only firestore,auth "yarn vitest run --config vitest.rules.config.ts"`
    or `yarn test:rules`
  </action>
  <verify>
    Run: `yarn test:rules`
    ALL test files pass (teams, users from 07-01 + surveys, team-subcollections, invitations, notifications-messages from this plan).
    Exit code 0. No skipped tests.
  </verify>
  <done>
    All Firestore collections have security rules tests covering allow/deny scenarios. Full suite passes via yarn test:rules. Collections covered: teams, users, surveys (+ votes subcollection), cashboxTransactions, fineRules, fines, payments, cashboxHistory, auditLogs, teamInvitations, notifications, messages.
  </done>
</task>

</tasks>

<verification>
1. `yarn test:rules` exits with code 0
2. All six test files pass:
   - teams.rules.test.ts (from 07-01)
   - users.rules.test.ts (from 07-01)
   - surveys.rules.test.ts
   - team-subcollections.rules.test.ts
   - invitations.rules.test.ts
   - notifications-messages.rules.test.ts
3. Every collection in firestore.rules has at least one allow and one deny test
4. Votes subcollection ownership (voteId == auth.uid) is tested
5. AuditLogs actorUid validation is tested
6. Invitation status transition rules are tested (pending -> accepted/declined only)
</verification>

<success_criteria>
- All Firestore collections from firestore.rules have corresponding test coverage
- Each collection tests both allow AND deny scenarios
- Special validation rules tested: vote ownership, audit actorUid, invitation status transitions, team join-via-update
- Full suite (6 files) passes with yarn test:rules in single command
</success_criteria>

<output>
After completion, create `.planning/phases/07-test-infrastructure/07-02-SUMMARY.md`
</output>
