---
phase: 07-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - firebase.json
  - vitest.rules.config.ts
  - package.json
  - tests/rules/helpers/setup.ts
  - tests/rules/teams.rules.test.ts
  - tests/rules/users.rules.test.ts
autonomous: true

must_haves:
  truths:
    - "Developer runs yarn test:rules and Firebase emulators start on ports 9099/8080, tests execute, emulators shut down"
    - "Teams collection rules are tested: member read/write, outsider deny, creator delete, create validation, join-via-update validation, admin access"
    - "Users collection rules are tested: own read/write, other-user read, unauthenticated deny"
  artifacts:
    - path: "firebase.json"
      provides: "Emulator configuration block with auth:9099, firestore:8080, singleProjectMode"
      contains: "emulators"
    - path: "vitest.rules.config.ts"
      provides: "Dedicated Vitest config for rules tests with environment: node"
      contains: "environment: 'node'"
    - path: "tests/rules/helpers/setup.ts"
      provides: "Shared initializeTestEnvironment wrapper"
      exports: ["createTestEnv"]
    - path: "tests/rules/teams.rules.test.ts"
      provides: "Teams collection security rules tests"
      min_lines: 80
    - path: "tests/rules/users.rules.test.ts"
      provides: "Users collection security rules tests"
      min_lines: 30
    - path: "package.json"
      provides: "test:rules script using firebase emulators:exec"
      contains: "test:rules"
  key_links:
    - from: "package.json test:rules script"
      to: "firebase emulators:exec"
      via: "npm script invoking Firebase CLI"
      pattern: "firebase emulators:exec"
    - from: "vitest.rules.config.ts"
      to: "tests/rules/**/*.rules.test.ts"
      via: "include glob"
      pattern: "tests/rules/.*\\.rules\\.test\\.ts"
    - from: "tests/rules/helpers/setup.ts"
      to: "firestore.rules"
      via: "readFileSync loading rules content"
      pattern: "readFileSync.*firestore\\.rules"
---

<objective>
Set up Firebase emulator configuration, dedicated Vitest config for security rules tests, shared test helper, npm scripts, and write initial security rules tests for teams and users collections.

Purpose: Establish the complete test infrastructure so that `yarn test:rules` starts emulators, runs tests, and shuts down automatically. Validate the infrastructure works end-to-end with two collections before expanding coverage.
Output: Working test pipeline, teams rules tests, users rules tests
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-test-infrastructure/07-RESEARCH.md
@firestore.rules
@firebase.json
@vitest.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependency and configure emulator infrastructure</name>
  <files>
    package.json
    firebase.json
    vitest.rules.config.ts
    tests/rules/helpers/setup.ts
  </files>
  <action>
    1. Install @firebase/rules-unit-testing as dev dependency:
       `yarn add -D @firebase/rules-unit-testing`

    2. Add emulators block to firebase.json (preserve all existing config):
       ```json
       "emulators": {
         "auth": { "port": 9099 },
         "firestore": { "port": 8080 },
         "ui": { "enabled": true, "port": 4000 },
         "singleProjectMode": true
       }
       ```

    3. Create vitest.rules.config.ts at project root:
       - Use defineConfig from 'vitest/config'
       - Set resolve.alias for '@' to './src' (same as existing vitest.config.ts)
       - Set test.environment to 'node' (NOT happy-dom â€” rules tests need Node.js for @firebase/rules-unit-testing)
       - Set test.include to ['tests/rules/**/*.rules.test.ts']
       - Set test.globals to true
       - Set test.testTimeout to 15000 (emulator operations can be slow on Windows)
       - Set test.hookTimeout to 15000

    4. Create tests/rules/helpers/setup.ts:
       - Import initializeTestEnvironment, RulesTestEnvironment from '@firebase/rules-unit-testing'
       - Import readFileSync from 'node:fs'
       - Import resolve from 'node:path'
       - Export async function createTestEnv() that returns initializeTestEnvironment with:
         - projectId: 'club-surveys-test' (NOT the production project ID)
         - firestore.host: '127.0.0.1'
         - firestore.port: 8080
         - firestore.rules: readFileSync(resolve(process.cwd(), 'firestore.rules'), 'utf8')
       - Export RulesTestEnvironment type re-export for convenience

    5. Add npm scripts to package.json:
       - "test:rules": "firebase emulators:exec --only firestore,auth \"yarn vitest run --config vitest.rules.config.ts\""
       - "test:rules:watch": Omit this for now (Windows dangling CMD issue with emulators:start)
       - "emulators:start": "firebase emulators:start --only firestore,auth"

    NOTE on Windows/MINGW64 quoting: If the inline script string in test:rules causes quoting issues during execution, the executor should create a test-rules.sh script as fallback:
    ```bash
    #!/bin/bash
    yarn vitest run --config vitest.rules.config.ts
    ```
    And change script to: "test:rules": "firebase emulators:exec --only firestore,auth ./test-rules.sh"
  </action>
  <verify>
    - `yarn vitest --version` returns 4.x (vitest still works)
    - `node -e "require('@firebase/rules-unit-testing')"` or check node_modules/@firebase/rules-unit-testing exists
    - `cat firebase.json | grep -q emulators` confirms emulator config present
    - `cat vitest.rules.config.ts` exists with environment: 'node'
    - `cat tests/rules/helpers/setup.ts` exists with createTestEnv function
  </verify>
  <done>
    @firebase/rules-unit-testing installed, firebase.json has emulators block with auth:9099 and firestore:8080, vitest.rules.config.ts exists with node environment, shared test helper exports createTestEnv, package.json has test:rules script
  </done>
</task>

<task type="auto">
  <name>Task 2: Write teams collection security rules tests</name>
  <files>tests/rules/teams.rules.test.ts</files>
  <action>
    Create tests/rules/teams.rules.test.ts with comprehensive allow/deny tests for the teams collection and all its subcollections will be covered in plan 07-02.

    Test setup:
    - Import describe, it, beforeAll, beforeEach, afterEach, afterAll from vitest
    - Import assertFails, assertSucceeds, RulesTestEnvironment from @firebase/rules-unit-testing
    - Import doc, setDoc, getDoc, updateDoc, deleteDoc, collection, getDocs from firebase/firestore
    - Import createTestEnv from ./helpers/setup

    Constants:
    - TEAM_ID = 'team-001'
    - CREATOR_UID = 'creator-uid'
    - POWER_UID = 'power-uid'
    - MEMBER_UID = 'member-uid'
    - OUTSIDER_UID = 'outsider-uid'

    Lifecycle:
    - beforeAll: testEnv = await createTestEnv()
    - afterEach: await testEnv.clearFirestore()
    - afterAll: await testEnv.cleanup()

    Seed data in beforeEach (using withSecurityRulesDisabled):
    - teams/team-001: { name: 'FC Test', creator: CREATOR_UID, members: [CREATOR_UID, POWER_UID, MEMBER_UID], powerusers: [CREATOR_UID, POWER_UID] }

    Test cases for teams/{teamId}:

    describe('teams - read'):
    - allows team member to read team (MEMBER_UID)
    - allows power user to read team (POWER_UID)
    - denies outsider read of team (OUTSIDER_UID)
    - denies unauthenticated read of team
    - allows app admin to read team (admin custom claim)

    describe('teams - write'):
    - allows team member to update team (MEMBER_UID)
    - denies outsider write to team (OUTSIDER_UID)

    describe('teams - create'):
    - allows user to create team with self as creator/member/poweruser
    - denies creating team without self as creator

    describe('teams - delete'):
    - allows creator to delete team (CREATOR_UID)
    - allows app admin to delete team
    - denies member (non-creator) delete of team (MEMBER_UID)

    describe('teams - join via update'):
    - allows user to add themselves to members array (simulate invitation accept):
      Seed team with members: [CREATOR_UID], then OUTSIDER_UID updates with members: [CREATOR_UID, OUTSIDER_UID] keeping all other fields same
    - denies adding someone else to members array
    - denies removing existing member during join
  </action>
  <verify>
    Run: `firebase emulators:exec --only firestore,auth "yarn vitest run --config vitest.rules.config.ts tests/rules/teams.rules.test.ts"`
    All test cases pass. No test should be skipped.
  </verify>
  <done>
    teams.rules.test.ts has passing tests covering: member read, outsider deny, admin access, team creation validation, team deletion by creator/admin, join-via-update validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Write users collection security rules tests</name>
  <files>tests/rules/users.rules.test.ts</files>
  <action>
    Create tests/rules/users.rules.test.ts.

    Test setup: Same imports and lifecycle pattern as teams test file.

    Constants:
    - USER_A_UID = 'user-a'
    - USER_B_UID = 'user-b'

    Seed data in beforeEach:
    - users/user-a: { email: 'a@test.cz', displayName: 'User A', teamId: 'team-001' }
    - users/user-b: { email: 'b@test.cz', displayName: 'User B', teamId: 'team-001' }

    Test cases for users/{userId}:

    describe('users - own access'):
    - allows user to read own document (USER_A reads users/user-a)
    - allows user to write own document (USER_A writes to users/user-a)

    describe('users - other user access'):
    - allows authenticated user to read another user document (USER_B reads users/user-a)
    - denies authenticated user from writing another user document (USER_B writes to users/user-a)

    describe('users - unauthenticated'):
    - denies unauthenticated read of user document
    - denies unauthenticated write of user document

    After writing, run the full test suite to confirm both files pass:
    `firebase emulators:exec --only firestore,auth "yarn vitest run --config vitest.rules.config.ts"`

    If the inline script quoting fails on MINGW64, create test-rules.sh as described in Task 1 and update the package.json script accordingly.
  </action>
  <verify>
    Run: `yarn test:rules` (the npm script)
    All teams and users tests pass. Exit code 0.
    If yarn test:rules quoting fails, run directly: `firebase emulators:exec --only firestore,auth "yarn vitest run --config vitest.rules.config.ts"`
  </verify>
  <done>
    users.rules.test.ts passes with tests covering: own read/write, cross-user read allowed, cross-user write denied, unauthenticated denied. Full suite (teams + users) passes via yarn test:rules.
  </done>
</task>

</tasks>

<verification>
1. `yarn test:rules` exits with code 0 (emulators start, tests run, emulators stop)
2. Console output shows emulators binding to ports 9099 (auth) and 8080 (firestore)
3. All teams rules tests pass (member read, outsider deny, admin access, create validation, delete permissions, join update)
4. All users rules tests pass (own access, cross-user read, unauthenticated deny)
5. No production Firebase project is contacted during test execution (projectId is 'club-surveys-test')
</verification>

<success_criteria>
- firebase.json contains emulators configuration
- vitest.rules.config.ts exists with environment: 'node'
- tests/rules/helpers/setup.ts exports createTestEnv
- package.json has test:rules script
- teams.rules.test.ts and users.rules.test.ts pass all assertions
- yarn test:rules runs end-to-end without manual intervention
</success_criteria>

<output>
After completion, create `.planning/phases/07-test-infrastructure/07-01-SUMMARY.md`
</output>
