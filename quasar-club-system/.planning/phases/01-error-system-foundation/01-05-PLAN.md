---
phase: 01-error-system-foundation
plan: 05
type: execute
wave: 4
depends_on: ["01-03", "01-04"]
files_modified:
  - src/pages/SettingsPage.vue
  - src/services/authFirebase.ts
  - src/i18n/cs-CZ/index.js
  - src/i18n/en-US/index.js
autonomous: true

must_haves:
  truths:
    - "User sees specific error when current password is wrong during password change"
    - "User sees reauthentication error when session is stale"
    - "Password change shows retry button for network failures"
  artifacts:
    - path: "src/pages/SettingsPage.vue"
      provides: "Password change with typed error handling"
      contains: "instanceof AuthError"
    - path: "src/services/authFirebase.ts"
      provides: "Reauthentication error mapping"
      contains: "auth/requires-recent-login"
    - path: "src/i18n/cs-CZ/index.js"
      provides: "Settings page error messages"
      contains: "settings:"
  key_links:
    - from: "src/pages/SettingsPage.vue"
      to: "src/services/authFirebase.ts"
      via: "authFirebase.changeUserPassword"
      pattern: "changeUserPassword"
    - from: "src/pages/SettingsPage.vue"
      to: "src/errors"
      via: "import AuthError"
      pattern: "instanceof AuthError"
---

<objective>
Harden password change flow in SettingsPage with typed error handling and specific error messages for wrong password and reauthentication failures.

Purpose: Replace generic error handling with specific user feedback for password change edge cases
Output: SettingsPage with typed error handling, specific messages for wrong password and reauthentication, and retry support
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/PROJECT.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/ROADMAP.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/STATE.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/phases/01-error-system-foundation/01-RESEARCH.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/codebase/CONVENTIONS.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/src/pages/SettingsPage.vue
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/src/services/authFirebase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SettingsPage password change with typed error handling</name>
  <files>
    src/pages/SettingsPage.vue
    src/i18n/cs-CZ/index.js
    src/i18n/en-US/index.js
  </files>
  <action>
Update SettingsPage.vue password change flow to use typed errors:

**SettingsPage.vue changes (script section):**
- Add import: `import { AuthError } from '@/errors'`
- Add import: `import { notifyError, notifySuccess } from '@/services/notificationService'`
- Find `changePassword` function (lines ~365-403)
- Replace existing error handling:

Current code (lines 385-402):
```javascript
catch (error) {
  console.error('Error changing password:', error)

  let errorMessage = t('settings.password.changeError')
  if (error.code === 'auth/wrong-password') {
    errorMessage = t('settings.password.wrongPassword')
  } else if (error.code === 'auth/weak-password') {
    errorMessage = t('settings.password.weakPassword')
  }

  $q.notify({
    type: 'negative',
    message: errorMessage,
    icon: 'error'
  })
}
```

Replace with typed error handling:
```javascript
catch (error: unknown) {
  console.error('Error changing password:', error)

  if (error instanceof AuthError) {
    // Map specific auth error codes
    const shouldRetry = error.code === 'auth/network-request-failed'

    notifyError(error.message, {
      retry: shouldRetry,
      onRetry: shouldRetry ? () => changePassword() : undefined
    })
  } else {
    notifyError('errors.unexpected')
  }
}
```

- Update success notification to use notifySuccess:
  Replace lines 374-378:
  ```javascript
  $q.notify({
    type: 'positive',
    message: t('settings.password.changeSuccess'),
    icon: 'check_circle'
  })
  ```
  With:
  ```javascript
  notifySuccess('settings.password.changeSuccess')
  ```

**i18n updates:**

Verify these keys exist in settings section (add if missing):

Czech (cs-CZ/index.js):
```javascript
settings: {
  password: {
    changeSuccess: 'Heslo bylo úspěšně změněno',
    changeError: 'Nepodařilo se změnit heslo',
    wrongPassword: 'Současné heslo je nesprávné',
    weakPassword: 'Nové heslo je příliš slabé',
    // ... other settings keys
  }
}
```

English (en-US/index.js):
```javascript
settings: {
  password: {
    changeSuccess: 'Password changed successfully',
    changeError: 'Failed to change password',
    wrongPassword: 'Current password is incorrect',
    weakPassword: 'New password is too weak',
    // ... other settings keys
  }
}
```

Follow conventions: TypeScript typed catch, camelCase, no semicolons in .vue script.
  </action>
  <verify>
    TypeScript compilation succeeds: `npm run build`
    Test wrong password:
      - Enter wrong current password
      - Submit password change
      - Verify notification shows "Current password is incorrect" in Czech
      - Verify NO retry button (permanent error)
    Test weak password:
      - Enter weak new password (< 6 chars)
      - Verify notification shows "New password is too weak"
    Test network failure:
      - Simulate network offline
      - Attempt password change
      - Verify retry button appears
      - Click retry → password change attempted again
  </verify>
  <done>
    SettingsPage uses typed error handling
    Wrong password shows specific Czech/English message
    Weak password shows specific message
    Network failures show retry button
    Success uses notifySuccess helper
    No Quasar $q.notify direct calls in password change flow
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance authFirebase reauthentication error handling</name>
  <files>
    src/services/authFirebase.ts
  </files>
  <action>
Enhance changeUserPassword in authFirebase.ts to handle reauthentication flow per research Pattern 5:

Current implementation (lines 112-125):
```typescript
const changeUserPassword = async (currentPassword: string, newPassword: string): Promise<void> => {
  const auth = getAuth();
  if (!auth.currentUser?.email) throw new Error('No authenticated user');

  // Re-authenticate user first
  const credential = EmailAuthProvider.credential(
    auth.currentUser.email,
    currentPassword
  );
  await reauthenticateWithCredential(auth.currentUser, credential);

  // Update password
  await updatePassword(auth.currentUser, newPassword);
};
```

Update to handle requires-recent-login and map all errors:

```typescript
const changeUserPassword = async (currentPassword: string, newPassword: string): Promise<void> => {
  const auth = getAuth();
  if (!auth.currentUser?.email) {
    throw new AuthError('no-user', 'errors.auth.noUser')
  }

  try {
    // Re-authenticate user first
    const credential = EmailAuthProvider.credential(
      auth.currentUser.email,
      currentPassword
    );
    await reauthenticateWithCredential(auth.currentUser, credential);

    // Update password after successful reauthentication
    await updatePassword(auth.currentUser, newPassword);
  } catch (error: unknown) {
    // Map Firebase error to AuthError with proper i18n key
    throw mapFirebaseAuthError(error)
  }
};
```

Key improvements:
- No-user check throws typed AuthError with i18n key
- All Firebase errors (wrong-password, weak-password, network-failed, requires-recent-login) mapped via mapFirebaseAuthError
- Reauthentication happens before password update per research pattern
- Error messages already mapped to i18n in Plan 01

Follow conventions: Type unknown in catch, no semicolons, camelCase.
  </action>
  <verify>
    TypeScript compilation succeeds: `npm run build`
    Test reauthentication with wrong password:
      - Call changeUserPassword with wrong current password
      - Catch error and verify `error instanceof AuthError`
      - Verify `error.code === 'auth/wrong-password'` or 'auth/invalid-credential'
      - Verify `error.message === 'errors.auth.wrongPassword'` or similar i18n key
    Test weak password:
      - Call with weak new password
      - Verify AuthError with code 'auth/weak-password'
    Test no user:
      - Sign out and call changeUserPassword
      - Verify AuthError with code 'no-user'
  </verify>
  <done>
    changeUserPassword throws typed AuthError for all failures
    Wrong password during reauthentication mapped to AuthError
    Weak password mapped to AuthError
    No-user check throws AuthError with i18n key
    All errors use mapFirebaseAuthError for consistency
    Reauthentication flow preserved (credential check before password update)
  </done>
</task>

</tasks>

<verification>
Run full TypeScript build: `npm run build` (no errors)
Test password change flow end-to-end:
  1. Navigate to Settings page
  2. Attempt password change with wrong current password:
     - Verify notification shows Czech message "Současné heslo je nesprávné"
     - Verify NO retry button
  3. Attempt password change with weak new password:
     - Verify notification shows "Nové heslo je příliš slabé"
  4. Simulate network offline and attempt password change:
     - Verify notification shows network error
     - Verify retry button appears
     - Click retry → verify password change attempted again
  5. Successfully change password with correct inputs:
     - Verify success notification
     - Verify form clears
  6. Switch to English language:
     - Repeat error scenarios
     - Verify English messages appear
</verification>

<success_criteria>
- User sees specific error message when current password is wrong
- User sees reauthentication required message when session is stale (auth/requires-recent-login)
- User sees retry button for network failures during password change
- Password change uses typed AuthError throughout
- Success and error notifications use notificationService helpers
- Czech and English messages for all password change errors
- SettingsPage no longer uses direct Quasar $q.notify for password errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-error-system-foundation/01-05-SUMMARY.md`
</output>
