---
phase: 01-error-system-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/composable/useAuthUseCases.ts
  - src/composable/useAuthComposable.ts
  - src/composable/useSurveyUseCases.ts
  - src/composable/useTeamUseCases.ts
  - src/composable/useCashboxUseCases.ts
  - src/i18n/cs-CZ/index.js
  - src/i18n/en-US/index.js
autonomous: true

must_haves:
  truths:
    - "Use cases catch typed errors and show user notifications"
    - "Retry callbacks execute original operation on user click"
    - "Auth errors show retry button for network failures only"
  artifacts:
    - path: "src/composable/useAuthUseCases.ts"
      provides: "Auth use cases with typed error handling"
      contains: "instanceof AuthError"
    - path: "src/composable/useSurveyUseCases.ts"
      provides: "Survey use cases with retry support"
      contains: "notifyError"
    - path: "src/i18n/cs-CZ/index.js"
      provides: "Common retry messages"
      contains: "common:"
  key_links:
    - from: "src/composable/useAuthUseCases.ts"
      to: "src/services/notificationService.ts"
      via: "import notifyError"
      pattern: "import.*notifyError"
    - from: "src/composable/useSurveyUseCases.ts"
      to: "src/errors"
      via: "import FirestoreError"
      pattern: "instanceof FirestoreError"
---

<objective>
Update use case and composable layers to catch typed errors and display user-friendly notifications with retry support.

Purpose: Replace silent console.error failures with visible user feedback and retry mechanisms
Output: All use cases handle typed errors with notifications and appropriate retry actions
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/PROJECT.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/ROADMAP.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/STATE.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/phases/01-error-system-foundation/01-RESEARCH.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/codebase/CONVENTIONS.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/.planning/codebase/ARCHITECTURE.md
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/src/composable/useAuthUseCases.ts
@C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system/src/composable/useSurveyUseCases.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update auth use cases with error notifications and add retry i18n messages</name>
  <files>
    src/composable/useAuthUseCases.ts
    src/composable/useAuthComposable.ts
    src/i18n/cs-CZ/index.js
    src/i18n/en-US/index.js
  </files>
  <action>
Update auth use cases and composables to handle typed errors with notifications:

**Add retry messages to i18n (if not already present):**

Check cs-CZ/index.js and en-US/index.js for `common` section. Add retry-related messages if missing:

Czech (cs-CZ/index.js):
```javascript
common: {
  retry: 'Zkusit znovu',
  retrySuccess: 'Operace byla úspěšná',
  dismiss: 'Zavřít',
  // ... existing common messages
}
```

English (en-US/index.js):
```javascript
common: {
  retry: 'Retry',
  retrySuccess: 'Operation successful',
  dismiss: 'Dismiss',
  // ... existing common messages
}
```

**useAuthUseCases.ts changes:**
- Import { notifyError } from '@/services/notificationService'
- Import { AuthError, FirestoreError } from '@/errors'
- Find `signIn` function (calls authFirebase.loginUser)
- Update catch block:
  ```typescript
  catch (error: unknown) {
    if (error instanceof AuthError) {
      // Show notification with retry only for network errors
      const shouldRetry = error.code === 'auth/network-request-failed'
      notifyError(error.message, {
        retry: shouldRetry,
        onRetry: shouldRetry ? () => signIn(email, password) : undefined
      })
    } else {
      notifyError('errors.unexpected')
    }
    throw error // Re-throw for composable to handle navigation
  }
  ```
- Apply same pattern to other auth operations:
  - signUp → retry on network failures
  - refreshUser → retry on network failures
  - getUserFromFirestore → retry on unavailable errors

**useAuthComposable.ts changes:**
- Import { AuthError } from '@/errors'
- Find `loginUser` function
- Update catch block to type error:
  ```typescript
  catch (error: unknown) {
    console.error('Login Error:', error)
    // Error notification already shown by use case
    // Composable just logs and re-throws for component
    throw error
  }
  ```
- Remove duplicate `catch (error: any)` - replace with `catch (error: unknown)`
- Apply to registerUser, logoutUser

Follow conventions: Type unknown in catch, no semicolons, camelCase.
  </action>
  <verify>
    TypeScript compilation succeeds: `npm run build`
    No `catch (error: any)` in auth files: `grep -n "catch.*any" src/composable/useAuth*.ts`
    Test login with wrong password:
      - AuthError caught in use case
      - User sees Czech notification with error message
      - No retry button (wrong password is not retryable)
    Test login with network offline:
      - User sees notification with retry button
      - Click retry → login attempted again
  </verify>
  <done>
    Auth use cases catch AuthError and show notifications
    Network errors show retry button
    Non-retryable errors (wrong password, user not found) show notification without retry
    i18n messages for retry/retrySuccess/dismiss exist
    No `catch (error: any)` in auth composables
  </done>
</task>

<task type="auto">
  <name>Task 2: Update survey, team, and cashbox use cases with error notifications</name>
  <files>
    src/composable/useSurveyUseCases.ts
    src/composable/useTeamUseCases.ts
    src/composable/useCashboxUseCases.ts
  </files>
  <action>
Update remaining use cases to handle typed errors:

**useSurveyUseCases.ts changes:**
- Import { notifyError } from '@/services/notificationService'
- Import { FirestoreError } from '@/errors'
- Find all functions that call surveyFirebase (addSurvey, updateSurvey, deleteSurvey, addSurveyVote, voteOnSurvey)
- Wrap Firebase calls with try-catch:
  ```typescript
  try {
    await surveyFirebase.addSurvey(surveyData)
    notifySuccess('survey.createSuccess') // If success notification needed
  } catch (error: unknown) {
    if (error instanceof FirestoreError) {
      // Retry for transient errors only
      const shouldRetry = error.code === 'unavailable' || error.code === 'deadline-exceeded'
      notifyError(error.message, {
        retry: shouldRetry,
        onRetry: shouldRetry ? () => surveyFirebase.addSurvey(surveyData) : undefined
      })
    } else {
      notifyError('errors.unexpected')
    }
    throw error
  }
  ```
- Apply to:
  - addSurvey → retry on unavailable
  - updateSurvey → retry on unavailable
  - deleteSurvey → NO retry (delete is dangerous to retry)
  - voteOnSurvey → retry on unavailable

**useTeamUseCases.ts changes:**
- Import { notifyError } from '@/services/notificationService'
- Import { FirestoreError } from '@/errors'
- Update team operations:
  - createTeam → retry on unavailable
  - deleteTeam → NO retry (destructive operation)
  - addUserToTeam, removeUserFromTeam → retry on unavailable
  - getTeamByIdAndSetCurrentTeam → retry on unavailable

**useCashboxUseCases.ts changes:**
- Import { notifyError } from '@/services/notificationService'
- Import { FirestoreError } from '@/errors'
- Update cashbox operations:
  - addFine, addPayment → retry on unavailable
  - deleteFine, deletePayment → NO retry (destructive)
  - updateFineRule → retry on unavailable

**Retry decision matrix:**
- Retry: unavailable, deadline-exceeded, aborted (transient errors)
- NO retry: permission-denied, not-found, already-exists (permanent errors)
- NO retry: delete operations (avoid accidental double-delete)

For ALL use cases:
- Import notifyError from notificationService
- Import typed errors (AuthError, FirestoreError)
- Check instanceof before calling notifyError with error.message
- Only retry transient errors (network/availability issues)
- Never retry destructive operations (deletes)
- Re-throw error for composable/component to handle

Follow conventions: Type unknown in catch, camelCase, no semicolons.
  </action>
  <verify>
    TypeScript compilation succeeds: `npm run build`
    No untyped catches: `grep -rn "catch (error[^:])" src/composable/`
    Test survey creation:
      - Create survey
      - Simulate unavailable error
      - Verify retry button appears
      - Click retry → survey creation attempted again
    Test survey deletion:
      - Delete survey
      - Verify NO retry button (destructive operation)
    Test permission denied:
      - Attempt operation without permission
      - Verify error notification shows but NO retry
  </verify>
  <done>
    All use cases catch FirestoreError and show notifications
    Transient errors (unavailable, deadline-exceeded) show retry button
    Permanent errors (permission-denied, not-found) show notification without retry
    Destructive operations (deletes) never offer retry
    All catches typed as `catch (error: unknown)`
    Errors re-thrown for component handling
  </done>
</task>

</tasks>

<verification>
Run full TypeScript build: `npm run build` (no errors)
Search for untyped catches: `grep -rn "catch (error: any)" src/composable/` (should return empty)
Test application error flows:
  - Login with wrong password → notification shows "Incorrect password" in Czech, no retry
  - Login with network offline → notification shows network error, retry button appears
  - Create survey with unavailable database → notification shows, retry button works
  - Delete survey → notification on error but no retry button
Check i18n:
  - Switch language to English
  - Trigger error → verify English message appears
  - Retry button shows "Retry" in English
</verification>

<success_criteria>
- All use cases catch typed errors (AuthError, FirestoreError)
- User sees Czech/English notifications for all errors
- Retry button appears only for transient errors (network, unavailable)
- Retry callback executes original operation
- Destructive operations (deletes) never show retry
- No `catch (error: any)` remains in codebase
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-error-system-foundation/01-04-SUMMARY.md`
</output>
