---
phase: 02-listener-registry-system
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/composable/useTeamUseCases.ts
  - src/composable/useSurveyUseCases.ts
  - src/stores/teamStore.ts
  - src/components/new/TeamDropdown.vue
  - src/components/new/TeamCard.vue
  - src/components/CashboxComponent.vue
  - src/components/MessagesComponent.vue
  - src/pages/NotificationsPage.vue
  - src/components/notifications/NotificationsDropdown.vue
autonomous: true
must_haves:
  truths:
    - "All Firestore listeners are tracked by ListenerRegistry (no orphan unsubscribe functions in stores or local variables)"
    - "Team switching properly unsubscribes previous team-scoped listeners before establishing new ones"
    - "Cashbox, messages, and notification listeners are registered with the registry"
    - "Notification listener errors are surfaced via onError callback (LST-04)"
  artifacts:
    - path: "src/composable/useTeamUseCases.ts"
      provides: "Team listener registered with registry"
      contains: "listenerRegistry.register"
    - path: "src/composable/useSurveyUseCases.ts"
      provides: "Survey listener registered with registry"
      contains: "listenerRegistry.register"
    - path: "src/stores/teamStore.ts"
      provides: "Cleaned store without unsubscribe fields"
    - path: "src/components/new/TeamDropdown.vue"
      provides: "Team switching with explicit listener cleanup"
      contains: "listenerRegistry.unregisterByScope"
  key_links:
    - from: "src/composable/useTeamUseCases.ts"
      to: "src/services/listenerRegistry.ts"
      via: "register teams listener"
      pattern: "listenerRegistry\\.register\\('teams'"
    - from: "src/composable/useSurveyUseCases.ts"
      to: "src/services/listenerRegistry.ts"
      via: "register surveys listener"
      pattern: "listenerRegistry\\.register\\('surveys'"
    - from: "src/components/new/TeamDropdown.vue"
      to: "src/services/listenerRegistry.ts"
      via: "unregisterByScope('team') before switching"
      pattern: "listenerRegistry\\.unregisterByScope\\('team'\\)"
---

<objective>
Migrate all Firestore listeners to use ListenerRegistry, remove manual unsubscribe storage from stores and components, and implement proper team switching cleanup.

Purpose: Centralizes ALL listener lifecycle management so no listeners can leak, and team switching properly cleans up old listeners before creating new ones.
Output: All 9 listener types registered with ListenerRegistry, stores cleaned of unsubscribe fields, team switching uses registry cleanup.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-listener-registry-system/02-RESEARCH.md
@.planning/phases/02-listener-registry-system/02-01-SUMMARY.md
@src/composable/useTeamUseCases.ts
@src/composable/useSurveyUseCases.ts
@src/stores/teamStore.ts
@src/components/new/TeamDropdown.vue
@src/components/new/TeamCard.vue
@src/components/CashboxComponent.vue
@src/components/MessagesComponent.vue
@src/pages/NotificationsPage.vue
@src/components/notifications/NotificationsDropdown.vue
@src/services/listenerRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate use case listeners and clean teamStore</name>
  <files>src/composable/useTeamUseCases.ts, src/composable/useSurveyUseCases.ts, src/stores/teamStore.ts</files>
  <action>
**In src/composable/useTeamUseCases.ts:**
Import `listenerRegistry` from `@/services/listenerRegistry`.
In `setTeamListener()`:
- Remove the manual check `if (teamStore.unsubscribeTeams) { teamStore.unsubscribeTeams() }` — the registry auto-cleans on re-register.
- After creating the listener with `teamFirebase.getTeamsByUserId()`, register it: `listenerRegistry.register('teams', unsubscribe, { userId })`.
- Remove the call `teamStore.setTeamsUnsubscribe(unsubscribe)` — registry handles this.

**In src/composable/useSurveyUseCases.ts:**
Import `listenerRegistry` from `@/services/listenerRegistry`.
In `setSurveysListener()`:
- Remove the manual check `if (teamStore.unsubscribeSurveys) { teamStore.unsubscribeSurveys() }` — the registry auto-cleans.
- After creating the listener with `surveyFirebase.getSurveysByTeamId()`, register it: `listenerRegistry.register('surveys', unsubscribe, { teamId })`.
- Remove the call `teamStore.setSurveysUnsubscribe(unsubscribe)` — registry handles this.

**In src/stores/teamStore.ts:**
Remove: `unsubscribeTeams` ref, `unsubscribeSurveys` ref, `setTeamsUnsubscribe` function, `setSurveysUnsubscribe` function.
In `clearData()`: Remove the unsubscribe calls (lines that check and call unsubscribeTeams/unsubscribeSurveys). Keep the state clearing (teams=[], surveys=[], currentTeam=null, editedSurvey=null).
Remove `unsubscribeTeams`, `unsubscribeSurveys`, `setTeamsUnsubscribe`, `setSurveysUnsubscribe` from the return object.
  </action>
  <verify>Run `quasar build` to confirm no compilation errors. Grep for `unsubscribeTeams` and `unsubscribeSurveys` across src/ to confirm they are fully removed from all files.</verify>
  <done>Team and survey listeners registered with ListenerRegistry. teamStore no longer stores unsubscribe functions. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate component-level listeners, add team switching cleanup, and wire notification error callbacks (LST-04)</name>
  <files>src/components/new/TeamDropdown.vue, src/components/new/TeamCard.vue, src/components/CashboxComponent.vue, src/components/MessagesComponent.vue, src/pages/NotificationsPage.vue, src/components/notifications/NotificationsDropdown.vue</files>
  <action>
**In src/components/new/TeamDropdown.vue:**
Import `listenerRegistry` from `@/services/listenerRegistry`.
In `selectTeam()`:
- Before updating `teamStore.currentTeam`, call `listenerRegistry.unregisterByScope('team')` to clean up all team-scoped listeners (surveys, notifications, messages, cashbox-*).
- Then update `teamStore.currentTeam = team`.
- Then call `setSurveysListener(team.id)`.
This ensures stale data from previous team is properly cleaned up before new listeners start.

**In src/components/new/TeamCard.vue:**
Same pattern as TeamDropdown: import `listenerRegistry`, call `listenerRegistry.unregisterByScope('team')` before `setSurveysListener(props.team.id)` in the selectTeam handler.

**In src/components/CashboxComponent.vue:**
Import `listenerRegistry` from `@/services/listenerRegistry`.
In `setupListeners(teamId)`:
- Keep the call to `cleanupListeners()` but change it to use registry.
- After each `onSnapshot` call, register with registry:
  - `listenerRegistry.register('cashbox-fines', unsubFines, { teamId })`
  - `listenerRegistry.register('cashbox-payments', unsubPayments, { teamId })`
  - `listenerRegistry.register('cashbox-rules', unsubRules, { teamId })`
  - `listenerRegistry.register('cashbox-history', unsubHistory, { teamId })`
- Change `cleanupListeners()` to use registry: call `listenerRegistry.unregister('cashbox-fines')`, etc. for all 4 cashbox listeners. Remove the local `unsubFines`, `unsubPayments`, `unsubRules`, `unsubHistory` variables since registry tracks them.
- In `onBeforeUnmount`, call the simplified `cleanupListeners()` (which now uses registry).

**In src/components/MessagesComponent.vue:**
Import `listenerRegistry` from `@/services/listenerRegistry`.
- Replace local `let unsubscribe = null` with registry registration.
- Where messages listener is created (the `listenToMessages` call), register it: `listenerRegistry.register('messages', unsubscribe, { teamId })`.
- Where cleanup happens (the `if (unsubscribe) { unsubscribe() }` patterns), replace with `listenerRegistry.unregister('messages')`.
- Remove the local `unsubscribe` variable.

**In src/pages/NotificationsPage.vue (LST-04 error callback):**
Import `listenerRegistry` from `@/services/listenerRegistry`.
- Replace local `let unsubscribe = null` with registry registration.
- Where notification listener is created via `listenToNotifications(userId, pageSize, onData)`, add the 4th `onError` argument: `listenToNotifications(userId, pageSize, onData, (error) => { console.error('Notification listener error:', error.message) })`. The service's `listenToNotifications` already accepts `onError?: (error: Error) => void` as the 4th parameter but callers currently do not pass it.
- Register with registry: `listenerRegistry.register('notifications', unsubscribe, { userId })`.
- Where cleanup happens, replace with `listenerRegistry.unregister('notifications')`.
- Remove the local `unsubscribe` variable.

**In src/components/notifications/NotificationsDropdown.vue (LST-04 error callback):**
Import `listenerRegistry` from `@/services/listenerRegistry`.
- Same registry migration pattern: register with `listenerRegistry.register('notifications', ...)` and clean up with `listenerRegistry.unregister('notifications')`.
- Add the 4th `onError` argument to the `listenToNotifications` call: `listenToNotifications(userId, 10, onData, (error) => { console.error('Notification dropdown listener error:', error.message) })`. Currently only 3 args are passed (userId, pageSize, onData) — the optional `onError` callback is not wired.
- Remove local `unsubscribe` variable.

NOTE: NotificationsDropdown and NotificationsPage both use the 'notifications' ID. Since only one can be active at a time (dropdown is in layout, page replaces content), the auto-cleanup on re-register handles this correctly.
  </action>
  <verify>Run `quasar build` to confirm no compilation errors. Grep for `let unsubscribe = null` in the modified component files to confirm local unsubscribe variables are removed. Grep for `listenerRegistry` in each modified file to confirm registration. Grep for `onError` in NotificationsPage.vue and NotificationsDropdown.vue to confirm error callbacks are wired.</verify>
  <done>All 9 listener types (auth, teams, surveys, notifications, messages, cashbox-fines/payments/rules/history) registered with ListenerRegistry. No orphan unsubscribe storage. Team switching cleans up team-scoped listeners. Notification listeners pass onError callbacks (LST-04). Build passes.</done>
</task>

</tasks>

<verification>
- `quasar build` completes with no errors
- `grep -r "unsubscribeTeams\|unsubscribeSurveys\|setTeamsUnsubscribe\|setSurveysUnsubscribe" src/` returns zero matches
- `grep -r "listenerRegistry" src/composable/useTeamUseCases.ts src/composable/useSurveyUseCases.ts` shows registration calls
- `grep -r "listenerRegistry" src/components/new/TeamDropdown.vue` shows unregisterByScope call
- `grep -r "listenerRegistry" src/components/CashboxComponent.vue src/components/MessagesComponent.vue` shows registration
- `grep -r "onError" src/pages/NotificationsPage.vue src/components/notifications/NotificationsDropdown.vue` confirms error callbacks wired
</verification>

<success_criteria>
- All 9 listener types registered with ListenerRegistry
- teamStore has no unsubscribe fields
- TeamDropdown calls unregisterByScope('team') before team switch
- CashboxComponent uses registry instead of local unsubscribe variables
- MessagesComponent uses registry instead of local unsubscribe variable
- NotificationsPage and NotificationsDropdown use registry
- NotificationsPage and NotificationsDropdown pass onError callbacks to listenToNotifications (LST-04)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-listener-registry-system/02-02-SUMMARY.md`
</output>
