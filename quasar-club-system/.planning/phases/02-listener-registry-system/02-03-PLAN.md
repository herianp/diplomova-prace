---
phase: 02-listener-registry-system
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/App.vue
  - src/services/listenerRegistry.ts
autonomous: true
must_haves:
  truths:
    - "Application memory stays stable during extended sessions (App.vue safety net cleanup on unmount)"
    - "Developer can inspect active listeners via debug method in browser console"
    - "All listeners are cleaned up on logout (unregisterAll called)"
  artifacts:
    - path: "src/App.vue"
      provides: "Safety net cleanup via onBeforeUnmount"
      contains: "listenerRegistry.unregisterAll"
  key_links:
    - from: "src/App.vue"
      to: "src/services/listenerRegistry.ts"
      via: "onBeforeUnmount cleanup"
      pattern: "onBeforeUnmount.*listenerRegistry\\.unregisterAll"
---

<objective>
Add App.vue safety net cleanup and expose debug interface for developer inspection of active listeners.

Purpose: Provides a final safety net ensuring all listeners are cleaned up when the app unmounts (tab close, navigation away), and gives developers tools to inspect listener state for debugging memory leaks.
Output: App.vue with onBeforeUnmount cleanup, window.__listenerDebug available in dev mode.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-listener-registry-system/02-RESEARCH.md
@.planning/phases/02-listener-registry-system/02-01-SUMMARY.md
@.planning/phases/02-listener-registry-system/02-02-SUMMARY.md
@src/App.vue
@src/services/listenerRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add App.vue safety net and developer debug interface</name>
  <files>src/App.vue, src/services/listenerRegistry.ts</files>
  <action>
**In src/App.vue:**
Update the `<script setup>` section (currently empty with just `//`):
- Import `onBeforeUnmount` from `vue`
- Import `listenerRegistry` from `@/services/listenerRegistry`
- Add `onBeforeUnmount(() => { listenerRegistry.unregisterAll() })` as a safety net for when the entire app unmounts (tab close, navigation away)

**In src/services/listenerRegistry.ts:**
At the bottom of the file, after the singleton export, add a dev-mode debug exposure:
```typescript
// Expose debug interface in development mode
if (import.meta.env.DEV) {
  (window as any).__listenerDebug = {
    getActive: () => listenerRegistry.getActiveListeners(),
    getDebugInfo: () => listenerRegistry.getDebugInfo(),
    getCount: () => listenerRegistry.getCount()
  }
}
```

This allows developers to type `__listenerDebug.getDebugInfo()` in the browser console during development to inspect active listeners, their age, and context.
  </action>
  <verify>Run `quasar build` to confirm compilation passes. Check that App.vue has the onBeforeUnmount hook. Check that listenerRegistry.ts has the DEV debug exposure.</verify>
  <done>App.vue has onBeforeUnmount safety net. Developer debug interface available via window.__listenerDebug in dev mode. Build passes.</done>
</task>

</tasks>

<verification>
Run the following comprehensive checks after Task 1 to verify the entire Phase 2 implementation:

- `quasar build` passes with zero errors
- `grep -r "authUnsubscribe" src/` returns zero matches (removed in 02-01)
- `grep -r "unsubscribeTeams\|unsubscribeSurveys" src/` returns zero matches (removed in 02-02)
- `grep -r "listenerRegistry.register" src/` shows all 9 listener types registered: auth, teams, surveys, notifications, messages, cashbox-fines, cashbox-payments, cashbox-rules, cashbox-history
- `grep -r "listenerRegistry.unregisterAll" src/` shows calls in both useAuthUseCases.ts (logout) and App.vue (safety net)
- `grep -r "listenerRegistry.unregisterByScope" src/` shows call in TeamDropdown.vue (team switching)
- `grep -r "setTimeout" src/composable/useAuthUseCases.ts` returns zero matches (no timing buffers)
- `grep -r "onError" src/pages/NotificationsPage.vue src/components/notifications/NotificationsDropdown.vue` confirms error callbacks wired (LST-04)
- All 5 ROADMAP success criteria satisfied: (1) team switching cleans stale listeners, (2) no accumulating listeners, (3) permission errors surfaced via ListenerError, (4) no race conditions (Promise-based auth), (5) getDebugInfo available
</verification>

<success_criteria>
- Complete listener lifecycle coverage: creation -> tracking -> cleanup on all paths
- All 5 ROADMAP success criteria for Phase 2 are satisfiable
- Clean build with no TypeScript errors
- Zero manual unsubscribe storage remaining in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/02-listener-registry-system/02-03-SUMMARY.md`
</output>
