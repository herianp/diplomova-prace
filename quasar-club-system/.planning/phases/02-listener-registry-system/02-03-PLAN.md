---
phase: 02-listener-registry-system
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/App.vue
  - src/services/listenerRegistry.ts
autonomous: true
must_haves:
  truths:
    - "Application memory stays stable during extended sessions (App.vue safety net cleanup on unmount)"
    - "Developer can inspect active listeners via debug method in browser console"
    - "All listeners are cleaned up on logout (unregisterAll called)"
  artifacts:
    - path: "src/App.vue"
      provides: "Safety net cleanup via onBeforeUnmount"
      contains: "listenerRegistry.unregisterAll"
  key_links:
    - from: "src/App.vue"
      to: "src/services/listenerRegistry.ts"
      via: "onBeforeUnmount cleanup"
      pattern: "onBeforeUnmount.*listenerRegistry\\.unregisterAll"
---

<objective>
Add App.vue safety net cleanup and expose debug interface for developer inspection of active listeners.

Purpose: Provides a final safety net ensuring all listeners are cleaned up when the app unmounts (tab close, navigation away), and gives developers tools to inspect listener state for debugging memory leaks.
Output: App.vue with onBeforeUnmount cleanup, window.__listenerDebug available in dev mode.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-listener-registry-system/02-RESEARCH.md
@.planning/phases/02-listener-registry-system/02-01-SUMMARY.md
@.planning/phases/02-listener-registry-system/02-02-SUMMARY.md
@src/App.vue
@src/services/listenerRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add App.vue safety net and developer debug interface</name>
  <files>src/App.vue, src/services/listenerRegistry.ts</files>
  <action>
**In src/App.vue:**
Update the `<script setup>` section (currently empty with just `//`):
- Import `onBeforeUnmount` from `vue`
- Import `listenerRegistry` from `@/services/listenerRegistry`
- Add `onBeforeUnmount(() => { listenerRegistry.unregisterAll() })` as a safety net for when the entire app unmounts (tab close, navigation away)

**In src/services/listenerRegistry.ts:**
At the bottom of the file, after the singleton export, add a dev-mode debug exposure:
```typescript
// Expose debug interface in development mode
if (import.meta.env.DEV) {
  (window as any).__listenerDebug = {
    getActive: () => listenerRegistry.getActiveListeners(),
    getDebugInfo: () => listenerRegistry.getDebugInfo(),
    getCount: () => listenerRegistry.getCount()
  }
}
```

This allows developers to type `__listenerDebug.getDebugInfo()` in the browser console during development to inspect active listeners, their age, and context.
  </action>
  <verify>Run `quasar build` to confirm compilation passes. Check that App.vue has the onBeforeUnmount hook. Check that listenerRegistry.ts has the DEV debug exposure.</verify>
  <done>App.vue has onBeforeUnmount safety net. Developer debug interface available via window.__listenerDebug in dev mode. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Final verification of complete listener lifecycle</name>
  <files></files>
  <action>
Run a comprehensive verification of the entire Phase 2 implementation:

1. **Build check**: Run `quasar build` to confirm zero errors.

2. **No orphan unsubscribe storage**: Grep across entire src/ for patterns that indicate manual unsubscribe management that should have been migrated:
   - `authUnsubscribe` should return zero matches
   - `unsubscribeTeams` should return zero matches
   - `unsubscribeSurveys` should return zero matches
   - `let unsubscribe = null` in component files should return zero matches (all migrated to registry)

3. **Registry usage complete**: Grep for `listenerRegistry.register` to confirm all 9 listener types are registered:
   - auth (in useAuthUseCases.ts)
   - teams (in useTeamUseCases.ts)
   - surveys (in useSurveyUseCases.ts)
   - notifications (in NotificationsDropdown.vue and/or NotificationsPage.vue)
   - messages (in MessagesComponent.vue)
   - cashbox-fines, cashbox-payments, cashbox-rules, cashbox-history (in CashboxComponent.vue)

4. **Cleanup paths exist**: Verify:
   - `listenerRegistry.unregisterAll()` called in signOut path (useAuthUseCases.ts)
   - `listenerRegistry.unregisterAll()` called in App.vue onBeforeUnmount
   - `listenerRegistry.unregisterByScope('team')` called in TeamDropdown.vue selectTeam

5. **No timing buffers**: Grep for `setTimeout` in useAuthUseCases.ts â€” should return zero matches.

Report any issues found. If all checks pass, the phase is complete.
  </action>
  <verify>All grep checks return expected results. `quasar build` passes. No orphan unsubscribe patterns remain.</verify>
  <done>All 5 success criteria from ROADMAP verified: (1) team switching cleans up stale listeners, (2) no accumulating listeners, (3) permission errors surfaced via ListenerError, (4) no race conditions (Promise-based auth), (5) getDebugInfo available for developer inspection.</done>
</task>

</tasks>

<verification>
- `quasar build` passes with zero errors
- All 9 listener types registered with ListenerRegistry
- No orphan unsubscribe management in stores or components
- Logout path and App.vue both call unregisterAll
- Team switching calls unregisterByScope('team')
- No setTimeout buffers in auth initialization
- Developer debug interface available in dev mode
</verification>

<success_criteria>
- Complete listener lifecycle coverage: creation -> tracking -> cleanup on all paths
- All 5 ROADMAP success criteria for Phase 2 are satisfiable
- Clean build with no TypeScript errors
- Zero manual unsubscribe storage remaining in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/02-listener-registry-system/02-03-SUMMARY.md`
</output>
