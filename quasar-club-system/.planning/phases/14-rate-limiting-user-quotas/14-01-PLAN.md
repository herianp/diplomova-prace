---
phase: 14-rate-limiting-user-quotas
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/interfaces/interfaces.ts
  - src/services/rateLimitFirebase.ts
  - src/stores/rateLimitStore.ts
  - src/composable/useRateLimitUseCases.ts
  - src/components/admin/AdminRateLimitsTab.vue
  - src/components/admin/AdminComponent.vue
  - src/i18n/cs.json
  - src/i18n/en.json
autonomous: true
requirements:
  - RATE-01
  - RATE-04

must_haves:
  truths:
    - "Admin can view all 5 rate limit configurations in a table on the Admin page"
    - "Admin can edit any rate limit value inline and save it to Firestore"
    - "Default limits exist in Firestore without admin configuration"
  artifacts:
    - path: "src/interfaces/interfaces.ts"
      provides: "IRateLimitConfig and IUserUsage interfaces"
      contains: "IRateLimitConfig"
    - path: "src/services/rateLimitFirebase.ts"
      provides: "Firestore CRUD for rateLimits config document and usage counters"
      exports: ["useRateLimitFirebase"]
    - path: "src/stores/rateLimitStore.ts"
      provides: "Reactive rate limit config state with real-time listener"
      exports: ["useRateLimitStore"]
    - path: "src/composable/useRateLimitUseCases.ts"
      provides: "Business logic for loading config, updating limits, seeding defaults"
      exports: ["useRateLimitUseCases"]
    - path: "src/components/admin/AdminRateLimitsTab.vue"
      provides: "Admin UI tab with table and inline editing"
  key_links:
    - from: "src/components/admin/AdminRateLimitsTab.vue"
      to: "src/composable/useRateLimitUseCases.ts"
      via: "composable call for load/save"
      pattern: "useRateLimitUseCases"
    - from: "src/composable/useRateLimitUseCases.ts"
      to: "src/services/rateLimitFirebase.ts"
      via: "firebase service calls"
      pattern: "useRateLimitFirebase"
    - from: "src/components/admin/AdminComponent.vue"
      to: "src/components/admin/AdminRateLimitsTab.vue"
      via: "q-tab + q-tab-panel"
      pattern: "AdminRateLimitsTab"
---

<objective>
Create the rate limiting data layer (interfaces, Firebase service, store, use cases) and the admin UI tab for viewing and editing rate limit configurations.

Purpose: Establish the foundation — config storage, real-time sync, and admin management — so Plan 02 can enforce limits across the app.
Output: Working admin Rate Limits tab with inline editing, backed by Firestore `rateLimits` document.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-rate-limiting-user-quotas/14-CONTEXT.md
@src/interfaces/interfaces.ts
@src/components/admin/AdminComponent.vue
@src/services/adminFirebase.ts
@src/composable/useAdminUseCases.ts
@src/stores/teamStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data layer — interfaces, Firebase service, store, use cases, and default seeding</name>
  <files>
    src/interfaces/interfaces.ts
    src/services/rateLimitFirebase.ts
    src/stores/rateLimitStore.ts
    src/composable/useRateLimitUseCases.ts
  </files>
  <action>
1. In `src/interfaces/interfaces.ts`, add a new "Rate Limiting" section with:

```ts
export interface IRateLimitAction {
  key: string            // e.g. 'teamCreation', 'messages', 'joinRequests', 'surveys', 'fines'
  limit: number          // max count
  windowType: 'total' | 'weekly' | 'daily' | 'concurrent'
}

export interface IRateLimitConfig {
  teamCreation: number    // default 5, total
  messages: number        // default 50, weekly
  joinRequests: number    // default 5, concurrent pending
  surveys: number         // default 10, weekly
  fines: number           // default 500, daily per team
}

export interface IUserUsage {
  teamsCreated?: number
  messagesThisWeek?: number
  messagesWeekStart?: Date
  surveysThisWeek?: number
  surveysWeekStart?: Date
  pendingJoinRequests?: number  // computed from query, not stored
}
```

2. Create `src/services/rateLimitFirebase.ts` following the existing service pattern (see `adminFirebase.ts`):
   - `getRateLimitConfig()` — get the single `rateLimits/global` document. If it doesn't exist, create it with defaults and return defaults.
   - `setRateLimitListener(callback)` — real-time `onSnapshot` listener on `rateLimits/global` document. Returns unsubscribe function.
   - `updateRateLimitConfig(field: keyof IRateLimitConfig, value: number)` — update a single field on the config document using `updateDoc`.
   - `getUserUsage(userId: string)` — read `usage` sub-object from the user's document in `users` collection.
   - `incrementUserUsage(userId: string, field: string, value?: number)` — use `updateDoc` with `increment()` to bump a usage counter on the user document.
   - `resetWeeklyCounter(userId: string, field: string, weekStartField: string)` — set counter to 0 and weekStart to current date.
   - `getTeamUsage(teamId: string)` — read `usage` sub-object from team document.
   - `incrementTeamUsage(teamId: string, field: string)` — increment usage counter on team document.
   - `resetDailyCounter(teamId: string, field: string, dateStartField: string)` — reset daily counter on team document.

   Default config values: `{ teamCreation: 5, messages: 50, joinRequests: 5, surveys: 10, fines: 500 }`.

3. Create `src/stores/rateLimitStore.ts` using Pinia Setup Store pattern (consistent with existing stores):
   - State: `config: IRateLimitConfig | null`, `isLoaded: boolean`
   - Actions: `setConfig(config)`, `clearConfig()`
   - No business logic — pure state.

4. Create `src/composable/useRateLimitUseCases.ts` following existing use case pattern:
   - `loadConfig()` — calls firebase service, sets store
   - `startConfigListener()` — sets up real-time listener, updates store on changes. Register with `listenerRegistry` under scope 'rateLimits'.
   - `updateLimit(field: keyof IRateLimitConfig, value: number)` — validates value > 0, calls firebase, store updates via listener
   - `getDefaults(): IRateLimitConfig` — returns the default config object
  </action>
  <verify>
    TypeScript compilation: `cd C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system && npx vue-tsc --noEmit 2>&1 | head -20` shows no errors in the new files.
  </verify>
  <done>
    IRateLimitConfig and IUserUsage interfaces exist. Firebase service can read/write rateLimits config and user/team usage counters. Store holds reactive config. Use cases orchestrate loading, listening, and updating.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin Rate Limits tab with inline editing</name>
  <files>
    src/components/admin/AdminRateLimitsTab.vue
    src/components/admin/AdminComponent.vue
    src/i18n/cs.json
    src/i18n/en.json
  </files>
  <action>
1. Create `src/components/admin/AdminRateLimitsTab.vue`:
   - Uses `useRateLimitUseCases` to load config on mount and save edits.
   - Renders a `q-table` with columns: Action (string label), Limit (number), Window (string label like "total", "/week", "/day", "pending"), Edit (action column).
   - 5 rows, one per rate-limited action. Row data is derived from the store config + a static mapping of action keys to display labels and window types:
     ```
     const actionMeta = [
       { key: 'teamCreation', labelKey: 'admin.rateLimits.teamCreation', window: 'total' },
       { key: 'messages', labelKey: 'admin.rateLimits.messages', window: '/week' },
       { key: 'joinRequests', labelKey: 'admin.rateLimits.joinRequests', window: 'pending' },
       { key: 'surveys', labelKey: 'admin.rateLimits.surveys', window: '/week' },
       { key: 'fines', labelKey: 'admin.rateLimits.fines', window: '/day' },
     ]
     ```
   - Inline edit: clicking pencil icon sets `editingKey` ref. The Limit cell for that row becomes a `q-input` (type="number", min=1, dense). Enter key or checkmark icon saves via `updateLimit()`. Escape cancels edit.
   - Show `q-spinner` while saving, `q-notify` positive on success, negative on error.
   - Loading state while config loads.

2. Edit `src/components/admin/AdminComponent.vue`:
   - Import `AdminRateLimitsTab`.
   - Add a 4th `q-tab` with name="rateLimits", label from i18n `admin.rateLimitsTab`, icon="speed".
   - Add corresponding `q-tab-panel` with `<AdminRateLimitsTab />` (no props needed, self-contained).

3. Add i18n keys to both `src/i18n/cs.json` and `src/i18n/en.json` under `admin.rateLimits`:
   - `rateLimitsTab`: "Rate Limits" / "Limity"
   - `teamCreation`: "Team creation" / "Vytvoření týmu"
   - `messages`: "Messages" / "Zprávy"
   - `joinRequests`: "Join requests" / "Žádosti o připojení"
   - `surveys`: "Surveys" / "Ankety"
   - `fines`: "Fines (per team)" / "Pokuty (za tým)"
   - `actionColumn`: "Action" / "Akce"
   - `limitColumn`: "Limit" / "Limit"
   - `windowColumn`: "Window" / "Okno"
   - `editColumn`: "Edit" / "Upravit"
   - `saveSuccess`: "Limit updated" / "Limit aktualizován"
   - `saveError`: "Failed to update limit" / "Nepodařilo se aktualizovat limit"
   - Window type labels: `windowTotal`, `windowWeekly`, `windowDaily`, `windowPending`
  </action>
  <verify>
    Run `cd C:/Users/Developer/Documents/projekty/diplomova-prace/quasar-club-system && npx quasar dev` — navigate to Admin page, verify the "Rate Limits" tab appears with the 5-row table. Click the pencil icon on any row, change the number, press Enter — verify the value updates.
  </verify>
  <done>
    Admin page has a "Rate Limits" tab showing all 5 configurable limits in a table. Inline editing works: pencil icon opens number input, Enter saves to Firestore, value updates in real-time. Default values appear if no config document exists yet.
  </done>
</task>

</tasks>

<verification>
1. Admin Rate Limits tab renders 5 rows with correct default values
2. Editing a limit value persists to Firestore and reflects immediately
3. Real-time listener updates UI when config changes in another tab/browser
4. TypeScript compiles without errors
</verification>

<success_criteria>
- IRateLimitConfig interface defines all 5 action limits
- Firestore service handles config CRUD and usage counter operations
- Pinia store holds reactive config state
- Admin UI tab with inline editing is functional
- Default limits seed automatically on first access
</success_criteria>

<output>
After completion, create `.planning/phases/14-rate-limiting-user-quotas/14-01-SUMMARY.md`
</output>
