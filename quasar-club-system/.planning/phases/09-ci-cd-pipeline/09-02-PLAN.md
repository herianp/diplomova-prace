---
phase: 09-ci-cd-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - .github/workflows/deploy.yml
autonomous: false
user_setup:
  - service: firebase-hosting
    why: "Firebase Hosting deployment requires service account authentication"
    env_vars:
      - name: FIREBASE_SERVICE_ACCOUNT
        source: "Run `firebase init hosting:github` locally OR create service account in GCP Console -> IAM & Admin -> Service Accounts with 'Firebase Hosting Admin' role, download JSON key, paste entire JSON as GitHub secret"
      - name: VITE_FIREBASE_API_KEY
        source: "Firebase Console -> Project Settings -> General -> Web API Key (same value as in local .env file)"

must_haves:
  truths:
    - "Master branch push triggers test suite and deploys to Firebase Hosting on success"
    - "Deploy workflow runs lint, unit tests, security rules tests, and build before deploying"
    - "Deploy fails if any test or lint step fails (no partial deploy)"
    - "GitHub repository has FIREBASE_SERVICE_ACCOUNT and VITE_FIREBASE_API_KEY secrets configured"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Master deploy workflow with test-and-deploy job"
      contains: "push"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "FirebaseExtended/action-hosting-deploy@v0"
      via: "firebaseServiceAccount secret"
      pattern: "firebaseServiceAccount"
    - from: ".github/workflows/deploy.yml"
      to: "firebase.json"
      via: "projectId: club-surveys"
      pattern: "club-surveys"
---

<objective>
Create the deploy workflow for master branch and verify GitHub secrets are configured.

Purpose: Automate production deployment — every push to master runs the full test suite (lint + unit tests + security rules + build) and deploys to Firebase Hosting only when all checks pass.

Output: `.github/workflows/deploy.yml` workflow file and verified GitHub repository secrets.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ci-cd-pipeline/09-RESEARCH.md
@.planning/phases/09-ci-cd-pipeline/09-01-SUMMARY.md
@package.json
@firebase.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy workflow for master branch</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create `.github/workflows/deploy.yml` with the following structure.

**Trigger:** `push` to `master` branch only.

**NO concurrency group** — do not cancel in-progress production deploys.

**Single sequential job: `test-and-deploy`** (runs-on: ubuntu-latest, timeout-minutes: 30):

Steps in order:
1. `actions/checkout@v4`
2. `actions/setup-node@v4` with `node-version: '22'`, `cache: 'yarn'`
3. `actions/setup-java@v4` with `distribution: 'temurin'`, `java-version: '17'`
4. Cache Firebase emulator binaries with `actions/cache@v4`:
   - path: `~/.cache/firebase/emulators`
   - key: `firebase-emulators-${{ hashFiles('package.json') }}`
5. `yarn install --frozen-lockfile`
6. `yarn lint`
7. `yarn test:coverage`
8. `yarn test:rules`
9. `yarn build`
10. `FirebaseExtended/action-hosting-deploy@v0` with:
    - `repoToken: ${{ secrets.GITHUB_TOKEN }}`
    - `firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}`
    - `channelId: live`
    - `projectId: club-surveys`

env block on job level: `VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}`

IMPORTANT: Steps are sequential in one job (not parallel) because deploy must only happen after ALL checks pass. This is intentional — unlike the CI workflow where jobs run in parallel for speed, deploy needs guaranteed gate.

Use the exact workflow YAML from the research file's "Complete Deploy Workflow" code example.
  </action>
  <verify>Validate YAML syntax. Verify the file contains all 10 steps in the correct order. Verify `channelId: live` and `projectId: club-surveys` are present.</verify>
  <done>`.github/workflows/deploy.yml` exists with single sequential test-and-deploy job, all steps from lint through Firebase Hosting deploy.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure GitHub repository secrets</name>
  <action>
The deploy workflow requires two GitHub repository secrets that Claude cannot create (requires GitHub repository admin access):

**Secret 1: `VITE_FIREBASE_API_KEY`**
- Value: Your Firebase Web API Key (same as in your local `.env` file)
- Source: Firebase Console -> Project Settings -> General -> Web API Key
- Also needed by CI workflow (Plan 01) for build and test steps

**Secret 2: `FIREBASE_SERVICE_ACCOUNT`**
- Value: Entire JSON contents of a Firebase service account key file
- How to generate:
  Option A (recommended): Run `firebase init hosting:github` locally — this creates the service account with correct permissions and offers to set the GitHub secret automatically
  Option B: GCP Console -> IAM & Admin -> Service Accounts -> Create service account -> Grant "Firebase Hosting Admin" role -> Create JSON key -> Copy entire JSON as GitHub secret value

**Where to add secrets:**
GitHub repo -> Settings -> Secrets and variables -> Actions -> New repository secret
  </action>
  <how-to-verify>
1. Go to your GitHub repository Settings -> Secrets and variables -> Actions
2. Verify `VITE_FIREBASE_API_KEY` secret exists
3. Verify `FIREBASE_SERVICE_ACCOUNT` secret exists
4. (Optional) Push a commit to master or create a test PR to verify workflows trigger
  </how-to-verify>
  <resume-signal>Type "secrets configured" when both secrets are added to the GitHub repository</resume-signal>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy.yml` exists and is valid YAML
2. Deploy workflow has `on: push: branches: [master]` trigger
3. Deploy workflow has single `test-and-deploy` job with sequential steps
4. Deploy step uses `FirebaseExtended/action-hosting-deploy@v0` with correct projectId
5. GitHub repository has `FIREBASE_SERVICE_ACCOUNT` and `VITE_FIREBASE_API_KEY` secrets
6. No concurrency group on deploy workflow (intentional)
</verification>

<success_criteria>
- Deploy workflow created with full test gate before Firebase Hosting deploy
- GitHub secrets configured for authentication
- Master push triggers full test + deploy pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/09-ci-cd-pipeline/09-02-SUMMARY.md`
</output>
