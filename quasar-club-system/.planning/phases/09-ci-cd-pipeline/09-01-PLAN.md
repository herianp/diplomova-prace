---
phase: 09-ci-cd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "PR against master triggers lint, unit tests, security rules tests, and build checks in parallel jobs"
    - "CI build fails when test coverage drops below 70% threshold"
    - "Developer sees vitest coverage report comment directly in GitHub PR"
    - "Coverage reporters include json and json-summary for PR comment action"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "PR check workflow with 3 parallel jobs"
      contains: "pull_request"
    - path: "vitest.config.ts"
      provides: "Coverage reporters including json and json-summary"
      contains: "json-summary"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "vitest.config.ts"
      via: "yarn test:coverage reads coverage config"
      pattern: "yarn test:coverage"
---

<objective>
Create the CI workflow for PR checks and update vitest coverage reporters.

Purpose: Enable automated quality gates on every pull request — lint, build, unit tests with coverage reporting, and security rules tests run in parallel GitHub Actions jobs.

Output: `.github/workflows/ci.yml` workflow file and updated `vitest.config.ts` with json/json-summary reporters.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ci-cd-pipeline/09-RESEARCH.md
@vitest.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add json and json-summary coverage reporters to vitest config</name>
  <files>vitest.config.ts</files>
  <action>
In `vitest.config.ts`, update the `coverage.reporter` array from `['text', 'lcov', 'html']` to `['text', 'lcov', 'html', 'json', 'json-summary']`.

These two additional reporters are required by `davelosert/vitest-coverage-report-action@v2` to generate PR coverage comments. The `json` reporter produces `coverage/coverage-final.json` (per-file detail) and `json-summary` produces `coverage/coverage-summary.json` (summary).

No other changes to vitest.config.ts.
  </action>
  <verify>Run `yarn test:coverage` and confirm `coverage/coverage-final.json` and `coverage/coverage-summary.json` are generated alongside existing lcov/html output.</verify>
  <done>vitest.config.ts has 5 reporters: text, lcov, html, json, json-summary. Both JSON files are generated on test run.</done>
</task>

<task type="auto">
  <name>Task 2: Create CI workflow for PR checks</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with the following structure. Create the `.github/workflows/` directory first.

**Trigger:** `pull_request` targeting `master` branch.

**Concurrency:** Add concurrency group to cancel in-progress runs on same PR:
```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```

**Three parallel jobs:**

1. **`lint-and-build`** (runs-on: ubuntu-latest):
   - `actions/checkout@v4`
   - `actions/setup-node@v4` with `node-version: '22'`, `cache: 'yarn'`
   - `yarn install --frozen-lockfile`
   - `yarn lint`
   - `yarn build`
   - env: `VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}`

2. **`unit-tests`** (runs-on: ubuntu-latest):
   - `actions/checkout@v4`
   - `actions/setup-node@v4` with `node-version: '22'`, `cache: 'yarn'`
   - `yarn install --frozen-lockfile`
   - `yarn test:coverage`
   - `davelosert/vitest-coverage-report-action@v2` with `if: always()` and `github-token: ${{ secrets.GITHUB_TOKEN }}`
   - env: `VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}`

3. **`security-rules-tests`** (runs-on: ubuntu-latest, timeout-minutes: 15):
   - `actions/checkout@v4`
   - `actions/setup-node@v4` with `node-version: '22'`, `cache: 'yarn'`
   - `actions/setup-java@v4` with `distribution: 'temurin'`, `java-version: '17'`
   - Cache Firebase emulator binaries with `actions/cache@v4`:
     - path: `~/.cache/firebase/emulators`
     - key: `firebase-emulators-${{ hashFiles('package.json') }}`
   - `yarn install --frozen-lockfile`
   - `yarn test:rules`

IMPORTANT: Do NOT use `npm install -g firebase-tools` — it is already in devDependencies. Do NOT cache node_modules directly — `actions/setup-node` with `cache: 'yarn'` handles this.

Use the exact workflow YAML from the research file's "Complete CI Workflow" code example, adding the concurrency group (which was recommended in the open questions section but not in the example).
  </action>
  <verify>Validate YAML syntax by running `node -e "const yaml = require('yaml'); yaml.parse(require('fs').readFileSync('.github/workflows/ci.yml', 'utf8'))"` or `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"`. If neither yaml parser is available, use an online YAML validator or visually inspect indentation.</verify>
  <done>`.github/workflows/ci.yml` exists with 3 parallel jobs (lint-and-build, unit-tests, security-rules-tests), concurrency group, and all steps matching research specification.</done>
</task>

</tasks>

<verification>
1. `vitest.config.ts` contains `reporter: ['text', 'lcov', 'html', 'json', 'json-summary']`
2. `.github/workflows/ci.yml` exists and is valid YAML
3. CI workflow has `on: pull_request: branches: [master]` trigger
4. CI workflow has 3 jobs: lint-and-build, unit-tests, security-rules-tests
5. unit-tests job includes `davelosert/vitest-coverage-report-action@v2` step
6. security-rules-tests job includes `actions/setup-java@v4` and Firebase emulator cache
7. `yarn test:coverage` generates `coverage/coverage-final.json` and `coverage/coverage-summary.json`
</verification>

<success_criteria>
- PR workflow file created with all 3 parallel jobs
- Vitest coverage reporters updated to support PR coverage comments
- Coverage threshold enforcement via existing vitest config (70% lines/functions/branches/statements)
- No new dependencies needed
</success_criteria>

<output>
After completion, create `.planning/phases/09-ci-cd-pipeline/09-01-SUMMARY.md`
</output>
