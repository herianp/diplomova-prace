---
phase: 04-data-model-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/featureFlags.ts
  - firestore.rules
  - src/services/surveyFirebase.ts
  - src/composable/useSurveyUseCases.ts
  - src/components/new/SurveyCard.vue
autonomous: true

must_haves:
  truths:
    - "Developer can toggle USE_VOTE_SUBCOLLECTIONS and DUAL_WRITE_VOTES feature flags to control vote storage backend"
    - "Firestore security rules allow team members to read/write their own votes in surveys/{surveyId}/votes/{userId} subcollection"
    - "All vote call sites use single voteOnSurvey use case (no addSurveyVoteUseCase, no addVote, no addSurveyVote wrappers)"
  artifacts:
    - path: "src/config/featureFlags.ts"
      provides: "Feature flag configuration for vote storage migration"
      contains: "USE_VOTE_SUBCOLLECTIONS"
    - path: "firestore.rules"
      provides: "Security rules for votes subcollection"
      contains: "match /votes/{voteId}"
    - path: "src/services/surveyFirebase.ts"
      provides: "Consolidated vote function without legacy wrappers"
    - path: "src/composable/useSurveyUseCases.ts"
      provides: "Single voteOnSurvey use case replacing addSurveyVoteUseCase"
  key_links:
    - from: "src/services/surveyFirebase.ts"
      to: "src/config/featureFlags.ts"
      via: "import isFeatureEnabled"
      pattern: "isFeatureEnabled"
    - from: "src/composable/useSurveyUseCases.ts"
      to: "src/services/surveyFirebase.ts"
      via: "addOrUpdateVote (only vote function)"
      pattern: "addOrUpdateVote"
---

<objective>
Create feature flag system, deploy votes subcollection security rules, and consolidate all vote functions to single addOrUpdateVote.

Purpose: Establishes foundation for subcollection migration — feature flags enable safe toggling, security rules must exist before any subcollection writes, and vote function consolidation (DAT-04) removes duplicates before adding subcollection logic.

Output: Feature flags file, updated firestore.rules with votes subcollection rules, consolidated vote service with no legacy wrappers.
</objective>

<execution_context>
@C:/Users/Developer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-model-migration/04-RESEARCH.md
@src/config/seasonConfig.ts
@src/services/surveyFirebase.ts
@src/composable/useSurveyUseCases.ts
@src/components/new/SurveyCard.vue
@firestore.rules
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature flags and update security rules</name>
  <files>src/config/featureFlags.ts, firestore.rules</files>
  <action>
1. Create `src/config/featureFlags.ts` with:
   - `USE_VOTE_SUBCOLLECTIONS: false` — toggles read source (array vs subcollection)
   - `DUAL_WRITE_VOTES: false` — enables writing to both array and subcollection during transition
   - Export `isFeatureEnabled(flag)` type-safe getter function
   - Export `FeatureFlagKey` type for compile-time safety
   - Use `as const` for the flags object

2. Update `firestore.rules` — add votes subcollection rules INSIDE the existing `match /surveys/{surveyId}` block (after line 23, before the closing brace). Add:
   ```
   match /votes/{voteId} {
     // Team members can read all votes for surveys they can access
     allow read: if request.auth != null &&
       isTeamMember(get(/databases/$(database)/documents/surveys/$(surveyId)).data.teamId);

     // Team members can create/update their own vote (voteId must equal auth UID)
     allow create, update: if request.auth != null &&
       voteId == request.auth.uid &&
       isTeamMember(get(/databases/$(database)/documents/surveys/$(surveyId)).data.teamId);

     // Power users have full access to votes
     allow read, write, delete: if isPowerUserForTeam(get(/databases/$(database)/documents/surveys/$(surveyId)).data.teamId);

     // App admin full access
     allow read, delete: if isAppAdmin();
   }
   ```
   Note: Use `get()` to fetch parent survey's teamId since subcollection rules don't inherit parent context. The voteId == request.auth.uid constraint ensures users can only write their own votes.
  </action>
  <verify>
Run `npx quasar build` to confirm no build errors from the new featureFlags.ts file. Visually inspect firestore.rules to confirm votes subcollection block is nested inside surveys match block.
  </verify>
  <done>
featureFlags.ts exists with both flags defaulting to false. firestore.rules has explicit votes subcollection rules allowing team members to read votes and write their own vote (voteId == auth.uid).
  </done>
</task>

<task type="auto">
  <name>Task 2: Consolidate vote functions and remove legacy wrappers</name>
  <files>src/services/surveyFirebase.ts, src/composable/useSurveyUseCases.ts, src/components/new/SurveyCard.vue</files>
  <action>
**In `src/services/surveyFirebase.ts`:**
1. Delete the `addVote` wrapper function (lines 125-127)
2. Delete the `addSurveyVote` wrapper function (lines 129-138)
3. Remove `addVote` and `addSurveyVote` from the return object
4. Keep only `addOrUpdateVote` as the single vote function
5. Export `addOrUpdateVote` in the return object (already exported, just confirm it's there)

**In `src/composable/useSurveyUseCases.ts`:**
1. Delete `addSurveyVoteUseCase` function (lines 121-142) — it duplicates `voteOnSurvey`
2. Remove `addSurveyVoteUseCase` from the return object
3. Update `voteOnSurvey` (line 105) to call `surveyFirebase.addOrUpdateVote` instead of `surveyFirebase.addVote`
4. Keep only `voteOnSurvey` as the single vote use case in the return object

**In `src/components/new/SurveyCard.vue`:**
1. Confirm it already uses `voteOnSurvey` from `useSurveyUseCases()` (line 155) — no changes needed since `addSurveyVote` in this component is a local function calling `voteOnSurvey`

**Verify no other files reference the removed functions:**
- Search for `addSurveyVoteUseCase` in all src files — should only be in useSurveyUseCases.ts
- Search for `.addVote(` and `.addSurveyVote(` — should have zero callers after cleanup
  </action>
  <verify>
Run `npx quasar build` — zero TypeScript errors. Grep for `addVote\b` and `addSurveyVote\b` in src/services/ and src/composable/ confirms only `addOrUpdateVote` remains. Grep for `addSurveyVoteUseCase` returns zero results. Grep SurveyCard.vue confirms it calls `voteOnSurvey` and does not reference the removed functions (`addVote`, `addSurveyVote`, `addSurveyVoteUseCase`).
  </verify>
  <done>
Only `addOrUpdateVote` exists in surveyFirebase.ts (no addVote, no addSurveyVote wrappers). Only `voteOnSurvey` exists in useSurveyUseCases.ts (no addSurveyVoteUseCase). All callers use the consolidated functions. Build passes with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `npx quasar build` completes with zero errors
2. `grep -r "addVote\b" src/services/` returns zero results (only addOrUpdateVote)
3. `grep -r "addSurveyVote\b" src/services/` returns zero results
4. `grep -r "addSurveyVoteUseCase" src/composable/` returns zero results
5. `src/config/featureFlags.ts` exists with USE_VOTE_SUBCOLLECTIONS and DUAL_WRITE_VOTES flags
6. `firestore.rules` contains `match /votes/{voteId}` inside surveys match block
</verification>

<success_criteria>
- Feature flags file created with both migration flags defaulting to false
- Security rules deployed for votes subcollection with proper team member and power user access
- All legacy vote function wrappers removed (addVote, addSurveyVote, addSurveyVoteUseCase)
- Single vote path: SurveyCard -> voteOnSurvey -> addOrUpdateVote
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-model-migration/04-01-SUMMARY.md`
</output>
